<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 Geometry operations | Geocomputation with R</title>
  <meta name="description" content="Chapter 5 Geometry operations | Geocomputation with R is for people who want to analyze, visualize and model geographic data with open source software. It is based on R, a statistical programming language that has powerful data processing, visualization, and geospatial capabilities. The book equips you with the knowledge and skills to tackle a wide range of issues manifested in geographic data, including those with scientific, societal, and environmental implications. This book will interest people from many backgrounds, especially Geographic Information Systems (GIS) users interested in applying their domain-specific knowledge in a powerful open source language for data science, and R users interested in extending their skills to handle spatial data." />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 Geometry operations | Geocomputation with R" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://geocompr.robinlovelace.net/" />
  <meta property="og:image" content="https://geocompr.robinlovelace.net/images/cover.png" />
  <meta property="og:description" content="Chapter 5 Geometry operations | Geocomputation with R is for people who want to analyze, visualize and model geographic data with open source software. It is based on R, a statistical programming language that has powerful data processing, visualization, and geospatial capabilities. The book equips you with the knowledge and skills to tackle a wide range of issues manifested in geographic data, including those with scientific, societal, and environmental implications. This book will interest people from many backgrounds, especially Geographic Information Systems (GIS) users interested in applying their domain-specific knowledge in a powerful open source language for data science, and R users interested in extending their skills to handle spatial data." />
  <meta name="github-repo" content="Robinlovelace/geocompr" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 Geometry operations | Geocomputation with R" />
  
  <meta name="twitter:description" content="Chapter 5 Geometry operations | Geocomputation with R is for people who want to analyze, visualize and model geographic data with open source software. It is based on R, a statistical programming language that has powerful data processing, visualization, and geospatial capabilities. The book equips you with the knowledge and skills to tackle a wide range of issues manifested in geographic data, including those with scientific, societal, and environmental implications. This book will interest people from many backgrounds, especially Geographic Information Systems (GIS) users interested in applying their domain-specific knowledge in a powerful open source language for data science, and R users interested in extending their skills to handle spatial data." />
  <meta name="twitter:image" content="https://geocompr.robinlovelace.net/images/cover.png" />

<meta name="author" content="Robin Lovelace, Jakub Nowosad, Jannes Muenchow" />


<meta name="date" content="2021-01-10" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="spatial-operations.html"/>
<link rel="next" href="reproj-geo-data.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-99618359-1', 'auto');
  ga('send', 'pageview');

</script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Geocomputation with R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#how-to-contribute"><i class="fa fa-check"></i>How to contribute?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#reproducibility"><i class="fa fa-check"></i>Reproducibility</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#supporting-the-project"><i class="fa fa-check"></i>Supporting the project</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="foreword.html"><a href="foreword.html"><i class="fa fa-check"></i>Foreword</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#who-this-book-is-for"><i class="fa fa-check"></i>Who this book is for</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#how-to-read-this-book"><i class="fa fa-check"></i>How to read this book</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#why-r"><i class="fa fa-check"></i>Why R?</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#real-world-impact"><i class="fa fa-check"></i>Real-world impact</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#what-is-geocomputation"><i class="fa fa-check"></i><b>1.1</b> What is geocomputation?</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#why-use-r-for-geocomputation"><i class="fa fa-check"></i><b>1.2</b> Why use R for geocomputation?</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#software-for-geocomputation"><i class="fa fa-check"></i><b>1.3</b> Software for geocomputation</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#rs-spatial-ecosystem"><i class="fa fa-check"></i><b>1.4</b> R’s spatial ecosystem</a></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#the-history-of-r-spatial"><i class="fa fa-check"></i><b>1.5</b> The history of R-spatial</a></li>
<li class="chapter" data-level="1.6" data-path="intro.html"><a href="intro.html#exercises"><i class="fa fa-check"></i><b>1.6</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>I Foundations</b></span></li>
<li class="chapter" data-level="2" data-path="spatial-class.html"><a href="spatial-class.html"><i class="fa fa-check"></i><b>2</b> Geographic data in R</a><ul>
<li class="chapter" data-level="" data-path="spatial-class.html"><a href="spatial-class.html#prerequisites"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="2.1" data-path="spatial-class.html"><a href="spatial-class.html#intro-spatial-class"><i class="fa fa-check"></i><b>2.1</b> Introduction</a></li>
<li class="chapter" data-level="2.2" data-path="spatial-class.html"><a href="spatial-class.html#vector-data"><i class="fa fa-check"></i><b>2.2</b> Vector data</a><ul>
<li class="chapter" data-level="2.2.1" data-path="spatial-class.html"><a href="spatial-class.html#intro-sf"><i class="fa fa-check"></i><b>2.2.1</b> An introduction to simple features</a></li>
<li class="chapter" data-level="2.2.2" data-path="spatial-class.html"><a href="spatial-class.html#why-simple-features"><i class="fa fa-check"></i><b>2.2.2</b> Why simple features?</a></li>
<li class="chapter" data-level="2.2.3" data-path="spatial-class.html"><a href="spatial-class.html#basic-map"><i class="fa fa-check"></i><b>2.2.3</b> Basic map making</a></li>
<li class="chapter" data-level="2.2.4" data-path="spatial-class.html"><a href="spatial-class.html#base-args"><i class="fa fa-check"></i><b>2.2.4</b> Base plot arguments</a></li>
<li class="chapter" data-level="2.2.5" data-path="spatial-class.html"><a href="spatial-class.html#geometry"><i class="fa fa-check"></i><b>2.2.5</b> Geometry types</a></li>
<li class="chapter" data-level="2.2.6" data-path="spatial-class.html"><a href="spatial-class.html#sfg"><i class="fa fa-check"></i><b>2.2.6</b> Simple feature geometries (sfg)</a></li>
<li class="chapter" data-level="2.2.7" data-path="spatial-class.html"><a href="spatial-class.html#sfc"><i class="fa fa-check"></i><b>2.2.7</b> Simple feature columns (sfc)</a></li>
<li class="chapter" data-level="2.2.8" data-path="spatial-class.html"><a href="spatial-class.html#sf"><i class="fa fa-check"></i><b>2.2.8</b> The sf class</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="spatial-class.html"><a href="spatial-class.html#raster-data"><i class="fa fa-check"></i><b>2.3</b> Raster data</a><ul>
<li class="chapter" data-level="2.3.1" data-path="spatial-class.html"><a href="spatial-class.html#an-introduction-to-raster"><i class="fa fa-check"></i><b>2.3.1</b> An introduction to raster</a></li>
<li class="chapter" data-level="2.3.2" data-path="spatial-class.html"><a href="spatial-class.html#basic-map-raster"><i class="fa fa-check"></i><b>2.3.2</b> Basic map making</a></li>
<li class="chapter" data-level="2.3.3" data-path="spatial-class.html"><a href="spatial-class.html#raster-classes"><i class="fa fa-check"></i><b>2.3.3</b> Raster classes</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="spatial-class.html"><a href="spatial-class.html#crs-intro"><i class="fa fa-check"></i><b>2.4</b> Coordinate Reference Systems</a><ul>
<li class="chapter" data-level="2.4.1" data-path="spatial-class.html"><a href="spatial-class.html#geographic-coordinate-systems"><i class="fa fa-check"></i><b>2.4.1</b> Geographic coordinate systems</a></li>
<li class="chapter" data-level="2.4.2" data-path="spatial-class.html"><a href="spatial-class.html#projected-coordinate-reference-systems"><i class="fa fa-check"></i><b>2.4.2</b> Projected coordinate reference systems</a></li>
<li class="chapter" data-level="2.4.3" data-path="spatial-class.html"><a href="spatial-class.html#crs-in-r"><i class="fa fa-check"></i><b>2.4.3</b> CRSs in R</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="spatial-class.html"><a href="spatial-class.html#units"><i class="fa fa-check"></i><b>2.5</b> Units</a></li>
<li class="chapter" data-level="2.6" data-path="spatial-class.html"><a href="spatial-class.html#ex2"><i class="fa fa-check"></i><b>2.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="attr.html"><a href="attr.html"><i class="fa fa-check"></i><b>3</b> Attribute data operations</a><ul>
<li class="chapter" data-level="" data-path="attr.html"><a href="attr.html#prerequisites-1"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="3.1" data-path="attr.html"><a href="attr.html#introduction"><i class="fa fa-check"></i><b>3.1</b> Introduction</a></li>
<li class="chapter" data-level="3.2" data-path="attr.html"><a href="attr.html#vector-attribute-manipulation"><i class="fa fa-check"></i><b>3.2</b> Vector attribute manipulation</a><ul>
<li class="chapter" data-level="3.2.1" data-path="attr.html"><a href="attr.html#vector-attribute-subsetting"><i class="fa fa-check"></i><b>3.2.1</b> Vector attribute subsetting</a></li>
<li class="chapter" data-level="3.2.2" data-path="attr.html"><a href="attr.html#vector-attribute-aggregation"><i class="fa fa-check"></i><b>3.2.2</b> Vector attribute aggregation</a></li>
<li class="chapter" data-level="3.2.3" data-path="attr.html"><a href="attr.html#vector-attribute-joining"><i class="fa fa-check"></i><b>3.2.3</b> Vector attribute joining</a></li>
<li class="chapter" data-level="3.2.4" data-path="attr.html"><a href="attr.html#vec-attr-creation"><i class="fa fa-check"></i><b>3.2.4</b> Creating attributes and removing spatial information</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="attr.html"><a href="attr.html#manipulating-raster-objects"><i class="fa fa-check"></i><b>3.3</b> Manipulating raster objects</a><ul>
<li class="chapter" data-level="3.3.1" data-path="attr.html"><a href="attr.html#raster-subsetting"><i class="fa fa-check"></i><b>3.3.1</b> Raster subsetting</a></li>
<li class="chapter" data-level="3.3.2" data-path="attr.html"><a href="attr.html#summarizing-raster-objects"><i class="fa fa-check"></i><b>3.3.2</b> Summarizing raster objects</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="attr.html"><a href="attr.html#exercises-1"><i class="fa fa-check"></i><b>3.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="spatial-operations.html"><a href="spatial-operations.html"><i class="fa fa-check"></i><b>4</b> Spatial data operations</a><ul>
<li class="chapter" data-level="" data-path="spatial-operations.html"><a href="spatial-operations.html#prerequisites-2"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="4.1" data-path="spatial-operations.html"><a href="spatial-operations.html#introduction-1"><i class="fa fa-check"></i><b>4.1</b> Introduction</a></li>
<li class="chapter" data-level="4.2" data-path="spatial-operations.html"><a href="spatial-operations.html#spatial-vec"><i class="fa fa-check"></i><b>4.2</b> Spatial operations on vector data</a><ul>
<li class="chapter" data-level="4.2.1" data-path="spatial-operations.html"><a href="spatial-operations.html#spatial-subsetting"><i class="fa fa-check"></i><b>4.2.1</b> Spatial subsetting</a></li>
<li class="chapter" data-level="4.2.2" data-path="spatial-operations.html"><a href="spatial-operations.html#topological-relations"><i class="fa fa-check"></i><b>4.2.2</b> Topological relations</a></li>
<li class="chapter" data-level="4.2.3" data-path="spatial-operations.html"><a href="spatial-operations.html#spatial-joining"><i class="fa fa-check"></i><b>4.2.3</b> Spatial joining</a></li>
<li class="chapter" data-level="4.2.4" data-path="spatial-operations.html"><a href="spatial-operations.html#non-overlapping-joins"><i class="fa fa-check"></i><b>4.2.4</b> Non-overlapping joins</a></li>
<li class="chapter" data-level="4.2.5" data-path="spatial-operations.html"><a href="spatial-operations.html#spatial-aggr"><i class="fa fa-check"></i><b>4.2.5</b> Spatial data aggregation</a></li>
<li class="chapter" data-level="4.2.6" data-path="spatial-operations.html"><a href="spatial-operations.html#distance-relations"><i class="fa fa-check"></i><b>4.2.6</b> Distance relations</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="spatial-operations.html"><a href="spatial-operations.html#spatial-ras"><i class="fa fa-check"></i><b>4.3</b> Spatial operations on raster data</a><ul>
<li class="chapter" data-level="4.3.1" data-path="spatial-operations.html"><a href="spatial-operations.html#spatial-raster-subsetting"><i class="fa fa-check"></i><b>4.3.1</b> Spatial subsetting</a></li>
<li class="chapter" data-level="4.3.2" data-path="spatial-operations.html"><a href="spatial-operations.html#map-algebra"><i class="fa fa-check"></i><b>4.3.2</b> Map algebra</a></li>
<li class="chapter" data-level="4.3.3" data-path="spatial-operations.html"><a href="spatial-operations.html#local-operations"><i class="fa fa-check"></i><b>4.3.3</b> Local operations</a></li>
<li class="chapter" data-level="4.3.4" data-path="spatial-operations.html"><a href="spatial-operations.html#focal-operations"><i class="fa fa-check"></i><b>4.3.4</b> Focal operations</a></li>
<li class="chapter" data-level="4.3.5" data-path="spatial-operations.html"><a href="spatial-operations.html#zonal-operations"><i class="fa fa-check"></i><b>4.3.5</b> Zonal operations</a></li>
<li class="chapter" data-level="4.3.6" data-path="spatial-operations.html"><a href="spatial-operations.html#global-operations-and-distances"><i class="fa fa-check"></i><b>4.3.6</b> Global operations and distances</a></li>
<li class="chapter" data-level="4.3.7" data-path="spatial-operations.html"><a href="spatial-operations.html#map-algebra-counterparts-in-vector-processing"><i class="fa fa-check"></i><b>4.3.7</b> Map algebra counterparts in vector processing</a></li>
<li class="chapter" data-level="4.3.8" data-path="spatial-operations.html"><a href="spatial-operations.html#merging-rasters"><i class="fa fa-check"></i><b>4.3.8</b> Merging rasters</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="spatial-operations.html"><a href="spatial-operations.html#exercises-2"><i class="fa fa-check"></i><b>4.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="geometric-operations.html"><a href="geometric-operations.html"><i class="fa fa-check"></i><b>5</b> Geometry operations</a><ul>
<li class="chapter" data-level="" data-path="geometric-operations.html"><a href="geometric-operations.html#prerequisites-3"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="5.1" data-path="geometric-operations.html"><a href="geometric-operations.html#introduction-2"><i class="fa fa-check"></i><b>5.1</b> Introduction</a></li>
<li class="chapter" data-level="5.2" data-path="geometric-operations.html"><a href="geometric-operations.html#geo-vec"><i class="fa fa-check"></i><b>5.2</b> Geometric operations on vector data</a><ul>
<li class="chapter" data-level="5.2.1" data-path="geometric-operations.html"><a href="geometric-operations.html#simplification"><i class="fa fa-check"></i><b>5.2.1</b> Simplification</a></li>
<li class="chapter" data-level="5.2.2" data-path="geometric-operations.html"><a href="geometric-operations.html#centroids"><i class="fa fa-check"></i><b>5.2.2</b> Centroids</a></li>
<li class="chapter" data-level="5.2.3" data-path="geometric-operations.html"><a href="geometric-operations.html#buffers"><i class="fa fa-check"></i><b>5.2.3</b> Buffers</a></li>
<li class="chapter" data-level="5.2.4" data-path="geometric-operations.html"><a href="geometric-operations.html#affine-transformations"><i class="fa fa-check"></i><b>5.2.4</b> Affine transformations</a></li>
<li class="chapter" data-level="5.2.5" data-path="geometric-operations.html"><a href="geometric-operations.html#clipping"><i class="fa fa-check"></i><b>5.2.5</b> Clipping</a></li>
<li class="chapter" data-level="5.2.6" data-path="geometric-operations.html"><a href="geometric-operations.html#geometry-unions"><i class="fa fa-check"></i><b>5.2.6</b> Geometry unions</a></li>
<li class="chapter" data-level="5.2.7" data-path="geometric-operations.html"><a href="geometric-operations.html#type-trans"><i class="fa fa-check"></i><b>5.2.7</b> Type transformations</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="geometric-operations.html"><a href="geometric-operations.html#geo-ras"><i class="fa fa-check"></i><b>5.3</b> Geometric operations on raster data</a><ul>
<li class="chapter" data-level="5.3.1" data-path="geometric-operations.html"><a href="geometric-operations.html#geometric-intersections"><i class="fa fa-check"></i><b>5.3.1</b> Geometric intersections</a></li>
<li class="chapter" data-level="5.3.2" data-path="geometric-operations.html"><a href="geometric-operations.html#extent-and-origin"><i class="fa fa-check"></i><b>5.3.2</b> Extent and origin</a></li>
<li class="chapter" data-level="5.3.3" data-path="geometric-operations.html"><a href="geometric-operations.html#aggregation-and-disaggregation"><i class="fa fa-check"></i><b>5.3.3</b> Aggregation and disaggregation</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="geometric-operations.html"><a href="geometric-operations.html#raster-vector"><i class="fa fa-check"></i><b>5.4</b> Raster-vector interactions</a><ul>
<li class="chapter" data-level="5.4.1" data-path="geometric-operations.html"><a href="geometric-operations.html#raster-cropping"><i class="fa fa-check"></i><b>5.4.1</b> Raster cropping</a></li>
<li class="chapter" data-level="5.4.2" data-path="geometric-operations.html"><a href="geometric-operations.html#raster-extraction"><i class="fa fa-check"></i><b>5.4.2</b> Raster extraction</a></li>
<li class="chapter" data-level="5.4.3" data-path="geometric-operations.html"><a href="geometric-operations.html#rasterization"><i class="fa fa-check"></i><b>5.4.3</b> Rasterization</a></li>
<li class="chapter" data-level="5.4.4" data-path="geometric-operations.html"><a href="geometric-operations.html#spatial-vectorization"><i class="fa fa-check"></i><b>5.4.4</b> Spatial vectorization</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="geometric-operations.html"><a href="geometric-operations.html#exercises-3"><i class="fa fa-check"></i><b>5.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="reproj-geo-data.html"><a href="reproj-geo-data.html"><i class="fa fa-check"></i><b>6</b> Reprojecting geographic data</a><ul>
<li class="chapter" data-level="" data-path="reproj-geo-data.html"><a href="reproj-geo-data.html#prerequisites-4"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="6.1" data-path="reproj-geo-data.html"><a href="reproj-geo-data.html#introduction-3"><i class="fa fa-check"></i><b>6.1</b> Introduction</a></li>
<li class="chapter" data-level="6.2" data-path="reproj-geo-data.html"><a href="reproj-geo-data.html#when-to-reproject"><i class="fa fa-check"></i><b>6.2</b> When to reproject?</a></li>
<li class="chapter" data-level="6.3" data-path="reproj-geo-data.html"><a href="reproj-geo-data.html#which-crs-to-use"><i class="fa fa-check"></i><b>6.3</b> Which CRS to use?</a></li>
<li class="chapter" data-level="6.4" data-path="reproj-geo-data.html"><a href="reproj-geo-data.html#reproj-vec-geom"><i class="fa fa-check"></i><b>6.4</b> Reprojecting vector geometries</a></li>
<li class="chapter" data-level="6.5" data-path="reproj-geo-data.html"><a href="reproj-geo-data.html#modifying-map-projections"><i class="fa fa-check"></i><b>6.5</b> Modifying map projections</a></li>
<li class="chapter" data-level="6.6" data-path="reproj-geo-data.html"><a href="reproj-geo-data.html#reprojecting-raster-geometries"><i class="fa fa-check"></i><b>6.6</b> Reprojecting raster geometries</a></li>
<li class="chapter" data-level="6.7" data-path="reproj-geo-data.html"><a href="reproj-geo-data.html#exercises-4"><i class="fa fa-check"></i><b>6.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="read-write.html"><a href="read-write.html"><i class="fa fa-check"></i><b>7</b> Geographic data I/O</a><ul>
<li class="chapter" data-level="" data-path="read-write.html"><a href="read-write.html#prerequisites-5"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="7.1" data-path="read-write.html"><a href="read-write.html#introduction-4"><i class="fa fa-check"></i><b>7.1</b> Introduction</a></li>
<li class="chapter" data-level="7.2" data-path="read-write.html"><a href="read-write.html#retrieving-data"><i class="fa fa-check"></i><b>7.2</b> Retrieving open data</a></li>
<li class="chapter" data-level="7.3" data-path="read-write.html"><a href="read-write.html#geographic-data-packages"><i class="fa fa-check"></i><b>7.3</b> Geographic data packages</a></li>
<li class="chapter" data-level="7.4" data-path="read-write.html"><a href="read-write.html#geographic-web-services"><i class="fa fa-check"></i><b>7.4</b> Geographic web services</a></li>
<li class="chapter" data-level="7.5" data-path="read-write.html"><a href="read-write.html#file-formats"><i class="fa fa-check"></i><b>7.5</b> File formats</a></li>
<li class="chapter" data-level="7.6" data-path="read-write.html"><a href="read-write.html#data-input"><i class="fa fa-check"></i><b>7.6</b> Data input (I)</a><ul>
<li class="chapter" data-level="7.6.1" data-path="read-write.html"><a href="read-write.html#vector-data-1"><i class="fa fa-check"></i><b>7.6.1</b> Vector data</a></li>
<li class="chapter" data-level="7.6.2" data-path="read-write.html"><a href="read-write.html#raster-data-1"><i class="fa fa-check"></i><b>7.6.2</b> Raster data</a></li>
</ul></li>
<li class="chapter" data-level="7.7" data-path="read-write.html"><a href="read-write.html#data-output"><i class="fa fa-check"></i><b>7.7</b> Data output (O)</a><ul>
<li class="chapter" data-level="7.7.1" data-path="read-write.html"><a href="read-write.html#vector-data-2"><i class="fa fa-check"></i><b>7.7.1</b> Vector data</a></li>
<li class="chapter" data-level="7.7.2" data-path="read-write.html"><a href="read-write.html#raster-data-2"><i class="fa fa-check"></i><b>7.7.2</b> Raster data</a></li>
</ul></li>
<li class="chapter" data-level="7.8" data-path="read-write.html"><a href="read-write.html#visual-outputs"><i class="fa fa-check"></i><b>7.8</b> Visual outputs</a></li>
<li class="chapter" data-level="7.9" data-path="read-write.html"><a href="read-write.html#exercises-5"><i class="fa fa-check"></i><b>7.9</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>II Extensions</b></span></li>
<li class="chapter" data-level="8" data-path="adv-map.html"><a href="adv-map.html"><i class="fa fa-check"></i><b>8</b> Making maps with R</a><ul>
<li class="chapter" data-level="" data-path="adv-map.html"><a href="adv-map.html#prerequisites-6"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="8.1" data-path="adv-map.html"><a href="adv-map.html#introduction-5"><i class="fa fa-check"></i><b>8.1</b> Introduction</a></li>
<li class="chapter" data-level="8.2" data-path="adv-map.html"><a href="adv-map.html#static-maps"><i class="fa fa-check"></i><b>8.2</b> Static maps</a><ul>
<li class="chapter" data-level="8.2.1" data-path="adv-map.html"><a href="adv-map.html#tmap-basics"><i class="fa fa-check"></i><b>8.2.1</b> tmap basics</a></li>
<li class="chapter" data-level="8.2.2" data-path="adv-map.html"><a href="adv-map.html#map-obj"><i class="fa fa-check"></i><b>8.2.2</b> Map objects</a></li>
<li class="chapter" data-level="8.2.3" data-path="adv-map.html"><a href="adv-map.html#aesthetics"><i class="fa fa-check"></i><b>8.2.3</b> Aesthetics</a></li>
<li class="chapter" data-level="8.2.4" data-path="adv-map.html"><a href="adv-map.html#color-settings"><i class="fa fa-check"></i><b>8.2.4</b> Color settings</a></li>
<li class="chapter" data-level="8.2.5" data-path="adv-map.html"><a href="adv-map.html#layouts"><i class="fa fa-check"></i><b>8.2.5</b> Layouts</a></li>
<li class="chapter" data-level="8.2.6" data-path="adv-map.html"><a href="adv-map.html#faceted-maps"><i class="fa fa-check"></i><b>8.2.6</b> Faceted maps</a></li>
<li class="chapter" data-level="8.2.7" data-path="adv-map.html"><a href="adv-map.html#inset-maps"><i class="fa fa-check"></i><b>8.2.7</b> Inset maps</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="adv-map.html"><a href="adv-map.html#animated-maps"><i class="fa fa-check"></i><b>8.3</b> Animated maps</a></li>
<li class="chapter" data-level="8.4" data-path="adv-map.html"><a href="adv-map.html#interactive-maps"><i class="fa fa-check"></i><b>8.4</b> Interactive maps</a></li>
<li class="chapter" data-level="8.5" data-path="adv-map.html"><a href="adv-map.html#mapping-applications"><i class="fa fa-check"></i><b>8.5</b> Mapping applications</a></li>
<li class="chapter" data-level="8.6" data-path="adv-map.html"><a href="adv-map.html#other-mapping-packages"><i class="fa fa-check"></i><b>8.6</b> Other mapping packages</a></li>
<li class="chapter" data-level="8.7" data-path="adv-map.html"><a href="adv-map.html#exercises-6"><i class="fa fa-check"></i><b>8.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="gis.html"><a href="gis.html"><i class="fa fa-check"></i><b>9</b> Bridges to GIS software</a><ul>
<li class="chapter" data-level="" data-path="gis.html"><a href="gis.html#prerequisites-7"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="9.1" data-path="gis.html"><a href="gis.html#introduction-6"><i class="fa fa-check"></i><b>9.1</b> Introduction</a></li>
<li class="chapter" data-level="9.2" data-path="gis.html"><a href="gis.html#rqgis"><i class="fa fa-check"></i><b>9.2</b> (R)QGIS</a></li>
<li class="chapter" data-level="9.3" data-path="gis.html"><a href="gis.html#rsaga"><i class="fa fa-check"></i><b>9.3</b> (R)SAGA</a></li>
<li class="chapter" data-level="9.4" data-path="gis.html"><a href="gis.html#rgrass"><i class="fa fa-check"></i><b>9.4</b> GRASS through <strong>rgrass7</strong></a></li>
<li class="chapter" data-level="9.5" data-path="gis.html"><a href="gis.html#when-to-use-what"><i class="fa fa-check"></i><b>9.5</b> When to use what?</a></li>
<li class="chapter" data-level="9.6" data-path="gis.html"><a href="gis.html#other-bridges"><i class="fa fa-check"></i><b>9.6</b> Other bridges</a><ul>
<li class="chapter" data-level="9.6.1" data-path="gis.html"><a href="gis.html#gdal"><i class="fa fa-check"></i><b>9.6.1</b> Bridges to GDAL</a></li>
<li class="chapter" data-level="9.6.2" data-path="gis.html"><a href="gis.html#postgis"><i class="fa fa-check"></i><b>9.6.2</b> Bridges to spatial databases</a></li>
</ul></li>
<li class="chapter" data-level="9.7" data-path="gis.html"><a href="gis.html#exercises-7"><i class="fa fa-check"></i><b>9.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="algorithms.html"><a href="algorithms.html"><i class="fa fa-check"></i><b>10</b> Scripts, algorithms and functions</a><ul>
<li class="chapter" data-level="" data-path="algorithms.html"><a href="algorithms.html#prerequisites-8"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="10.1" data-path="algorithms.html"><a href="algorithms.html#intro-algorithms"><i class="fa fa-check"></i><b>10.1</b> Introduction</a></li>
<li class="chapter" data-level="10.2" data-path="algorithms.html"><a href="algorithms.html#scripts"><i class="fa fa-check"></i><b>10.2</b> Scripts</a></li>
<li class="chapter" data-level="10.3" data-path="algorithms.html"><a href="algorithms.html#geometric-algorithms"><i class="fa fa-check"></i><b>10.3</b> Geometric algorithms</a></li>
<li class="chapter" data-level="10.4" data-path="algorithms.html"><a href="algorithms.html#functions"><i class="fa fa-check"></i><b>10.4</b> Functions</a></li>
<li class="chapter" data-level="10.5" data-path="algorithms.html"><a href="algorithms.html#programming"><i class="fa fa-check"></i><b>10.5</b> Programming</a></li>
<li class="chapter" data-level="10.6" data-path="algorithms.html"><a href="algorithms.html#ex-algorithms"><i class="fa fa-check"></i><b>10.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="spatial-cv.html"><a href="spatial-cv.html"><i class="fa fa-check"></i><b>11</b> Statistical learning</a><ul>
<li class="chapter" data-level="" data-path="spatial-cv.html"><a href="spatial-cv.html#prerequisites-9"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="11.1" data-path="spatial-cv.html"><a href="spatial-cv.html#intro-cv1"><i class="fa fa-check"></i><b>11.1</b> Introduction</a></li>
<li class="chapter" data-level="11.2" data-path="spatial-cv.html"><a href="spatial-cv.html#case-landslide"><i class="fa fa-check"></i><b>11.2</b> Case study: Landslide susceptibility</a></li>
<li class="chapter" data-level="11.3" data-path="spatial-cv.html"><a href="spatial-cv.html#conventional-model"><i class="fa fa-check"></i><b>11.3</b> Conventional modeling approach in R</a></li>
<li class="chapter" data-level="11.4" data-path="spatial-cv.html"><a href="spatial-cv.html#intro-cv"><i class="fa fa-check"></i><b>11.4</b> Introduction to (spatial) cross-validation</a></li>
<li class="chapter" data-level="11.5" data-path="spatial-cv.html"><a href="spatial-cv.html#spatial-cv-with-mlr"><i class="fa fa-check"></i><b>11.5</b> Spatial CV with <strong>mlr</strong></a><ul>
<li class="chapter" data-level="11.5.1" data-path="spatial-cv.html"><a href="spatial-cv.html#glm"><i class="fa fa-check"></i><b>11.5.1</b> Generalized linear model</a></li>
<li class="chapter" data-level="11.5.2" data-path="spatial-cv.html"><a href="spatial-cv.html#svm"><i class="fa fa-check"></i><b>11.5.2</b> Spatial tuning of machine-learning hyperparameters</a></li>
</ul></li>
<li class="chapter" data-level="11.6" data-path="spatial-cv.html"><a href="spatial-cv.html#conclusions"><i class="fa fa-check"></i><b>11.6</b> Conclusions</a></li>
<li class="chapter" data-level="11.7" data-path="spatial-cv.html"><a href="spatial-cv.html#exercises-8"><i class="fa fa-check"></i><b>11.7</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>III Applications</b></span></li>
<li class="chapter" data-level="12" data-path="transport.html"><a href="transport.html"><i class="fa fa-check"></i><b>12</b> Transportation</a><ul>
<li class="chapter" data-level="" data-path="transport.html"><a href="transport.html#prerequisites-10"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="12.1" data-path="transport.html"><a href="transport.html#introduction-7"><i class="fa fa-check"></i><b>12.1</b> Introduction</a></li>
<li class="chapter" data-level="12.2" data-path="transport.html"><a href="transport.html#bris-case"><i class="fa fa-check"></i><b>12.2</b> A case study of Bristol</a></li>
<li class="chapter" data-level="12.3" data-path="transport.html"><a href="transport.html#transport-zones"><i class="fa fa-check"></i><b>12.3</b> Transport zones</a></li>
<li class="chapter" data-level="12.4" data-path="transport.html"><a href="transport.html#desire-lines"><i class="fa fa-check"></i><b>12.4</b> Desire lines</a></li>
<li class="chapter" data-level="12.5" data-path="transport.html"><a href="transport.html#routes"><i class="fa fa-check"></i><b>12.5</b> Routes</a></li>
<li class="chapter" data-level="12.6" data-path="transport.html"><a href="transport.html#nodes"><i class="fa fa-check"></i><b>12.6</b> Nodes</a></li>
<li class="chapter" data-level="12.7" data-path="transport.html"><a href="transport.html#route-networks"><i class="fa fa-check"></i><b>12.7</b> Route networks</a></li>
<li class="chapter" data-level="12.8" data-path="transport.html"><a href="transport.html#prioritizing-new-infrastructure"><i class="fa fa-check"></i><b>12.8</b> Prioritizing new infrastructure</a></li>
<li class="chapter" data-level="12.9" data-path="transport.html"><a href="transport.html#future-directions-of-travel"><i class="fa fa-check"></i><b>12.9</b> Future directions of travel</a></li>
<li class="chapter" data-level="12.10" data-path="transport.html"><a href="transport.html#ex-transport"><i class="fa fa-check"></i><b>12.10</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="location.html"><a href="location.html"><i class="fa fa-check"></i><b>13</b> Geomarketing</a><ul>
<li class="chapter" data-level="" data-path="location.html"><a href="location.html#prerequisites-11"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="13.1" data-path="location.html"><a href="location.html#introduction-8"><i class="fa fa-check"></i><b>13.1</b> Introduction</a></li>
<li class="chapter" data-level="13.2" data-path="location.html"><a href="location.html#case-study"><i class="fa fa-check"></i><b>13.2</b> Case study: bike shops in Germany</a></li>
<li class="chapter" data-level="13.3" data-path="location.html"><a href="location.html#tidy-the-input-data"><i class="fa fa-check"></i><b>13.3</b> Tidy the input data</a></li>
<li class="chapter" data-level="13.4" data-path="location.html"><a href="location.html#create-census-rasters"><i class="fa fa-check"></i><b>13.4</b> Create census rasters</a></li>
<li class="chapter" data-level="13.5" data-path="location.html"><a href="location.html#define-metropolitan-areas"><i class="fa fa-check"></i><b>13.5</b> Define metropolitan areas</a></li>
<li class="chapter" data-level="13.6" data-path="location.html"><a href="location.html#points-of-interest"><i class="fa fa-check"></i><b>13.6</b> Points of interest</a></li>
<li class="chapter" data-level="13.7" data-path="location.html"><a href="location.html#identifying-suitable-locations"><i class="fa fa-check"></i><b>13.7</b> Identifying suitable locations</a></li>
<li class="chapter" data-level="13.8" data-path="location.html"><a href="location.html#discussion-and-next-steps"><i class="fa fa-check"></i><b>13.8</b> Discussion and next steps</a></li>
<li class="chapter" data-level="13.9" data-path="location.html"><a href="location.html#exercises-9"><i class="fa fa-check"></i><b>13.9</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="eco.html"><a href="eco.html"><i class="fa fa-check"></i><b>14</b> Ecology</a><ul>
<li class="chapter" data-level="" data-path="eco.html"><a href="eco.html#prerequisites-12"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="14.1" data-path="eco.html"><a href="eco.html#introduction-9"><i class="fa fa-check"></i><b>14.1</b> Introduction</a></li>
<li class="chapter" data-level="14.2" data-path="eco.html"><a href="eco.html#data-and-data-preparation"><i class="fa fa-check"></i><b>14.2</b> Data and data preparation</a></li>
<li class="chapter" data-level="14.3" data-path="eco.html"><a href="eco.html#nmds"><i class="fa fa-check"></i><b>14.3</b> Reducing dimensionality</a></li>
<li class="chapter" data-level="14.4" data-path="eco.html"><a href="eco.html#modeling-the-floristic-gradient"><i class="fa fa-check"></i><b>14.4</b> Modeling the floristic gradient</a><ul>
<li class="chapter" data-level="14.4.1" data-path="eco.html"><a href="eco.html#mlr-building-blocks"><i class="fa fa-check"></i><b>14.4.1</b> <strong>mlr</strong> building blocks</a></li>
<li class="chapter" data-level="14.4.2" data-path="eco.html"><a href="eco.html#predictive-mapping"><i class="fa fa-check"></i><b>14.4.2</b> Predictive mapping</a></li>
</ul></li>
<li class="chapter" data-level="14.5" data-path="eco.html"><a href="eco.html#conclusions-1"><i class="fa fa-check"></i><b>14.5</b> Conclusions</a></li>
<li class="chapter" data-level="14.6" data-path="eco.html"><a href="eco.html#exercises-10"><i class="fa fa-check"></i><b>14.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="conclusion.html"><a href="conclusion.html"><i class="fa fa-check"></i><b>15</b> Conclusion</a><ul>
<li class="chapter" data-level="" data-path="conclusion.html"><a href="conclusion.html#prerequisites-13"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="15.1" data-path="conclusion.html"><a href="conclusion.html#introduction-10"><i class="fa fa-check"></i><b>15.1</b> Introduction</a></li>
<li class="chapter" data-level="15.2" data-path="conclusion.html"><a href="conclusion.html#package-choice"><i class="fa fa-check"></i><b>15.2</b> Package choice</a></li>
<li class="chapter" data-level="15.3" data-path="conclusion.html"><a href="conclusion.html#gaps"><i class="fa fa-check"></i><b>15.3</b> Gaps and overlaps</a></li>
<li class="chapter" data-level="15.4" data-path="conclusion.html"><a href="conclusion.html#next"><i class="fa fa-check"></i><b>15.4</b> Where to go next?</a></li>
<li class="chapter" data-level="15.5" data-path="conclusion.html"><a href="conclusion.html#benefit"><i class="fa fa-check"></i><b>15.5</b> The open source approach</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://robinlovelace.net/">Robin Lovelace</a></li>
<li><a href="https://nowosad.github.io/">Jakub Nowosad</a></li>
<li><a href="https://github.com/jannes-m/">Jannes Muenchow</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Geocomputation with R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="geometric-operations" class="section level1">
<h1><span class="header-section-number">Chapter 5</span> Geometry operations</h1>
<div id="prerequisites-3" class="section level2 unnumbered">
<h2>Prerequisites</h2>
<ul>
<li>This chapter uses the same packages as Chapter <a href="spatial-operations.html#spatial-operations">4</a> but with the addition of <strong>spDataLarge</strong>, which was installed in Chapter <a href="spatial-class.html#spatial-class">2</a>:</li>
</ul>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="geometric-operations.html#cb148-1"></a><span class="kw">library</span>(sf)</span>
<span id="cb148-2"><a href="geometric-operations.html#cb148-2"></a><span class="kw">library</span>(raster)</span>
<span id="cb148-3"><a href="geometric-operations.html#cb148-3"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb148-4"><a href="geometric-operations.html#cb148-4"></a><span class="kw">library</span>(spData)</span>
<span id="cb148-5"><a href="geometric-operations.html#cb148-5"></a><span class="kw">library</span>(spDataLarge)</span></code></pre></div>
</div>
<div id="introduction-2" class="section level2">
<h2><span class="header-section-number">5.1</span> Introduction</h2>
<p>The previous three chapters have demonstrated how geographic datasets are structured in R (Chapter <a href="spatial-class.html#spatial-class">2</a>) and how to manipulate them based on their non-geographic attributes (Chapter <a href="attr.html#attr">3</a>) and spatial properties (Chapter <a href="spatial-operations.html#spatial-operations">4</a>).
This chapter extends these skills.
After reading it — and attempting the exercises at the end — you should understand and have control over the geometry column in <code>sf</code> objects and the geographic location of pixels represented in rasters.</p>
<p>Section <a href="geometric-operations.html#geo-vec">5.2</a> covers transforming vector geometries with ‘unary’ and ‘binary’ operations.
<!-- TODO: add something on n-ary ops (RL) -->
Unary operations work on a single geometry in isolation.
This includes simplification (of lines and polygons), the creation of buffers and centroids, and shifting/scaling/rotating single geometries using ‘affine transformations’ (Sections <a href="geometric-operations.html#simplification">5.2.1</a> to <a href="geometric-operations.html#affine-transformations">5.2.4</a>).
Binary transformations modify one geometry based on the shape of another.
This includes clipping and geometry unions, covered in Sections <a href="geometric-operations.html#clipping">5.2.5</a> and <a href="geometric-operations.html#geometry-unions">5.2.6</a>, respectively.
Type transformations (from a polygon to a line, for example) are demonstrated in Section <a href="geometric-operations.html#type-trans">5.2.7</a>.</p>
<p>Section <a href="geometric-operations.html#geo-ras">5.3</a> covers geometric transformations on raster objects.
This involves changing the size and number of the underlying pixels, and assigning them new values.
It teaches how to change the resolution (also called raster aggregation and disaggregation), the extent and the origin of a raster.
These operations are especially useful if one would like to align raster datasets from diverse sources.
Aligned raster objects share a one-to-one correspondence between pixels, allowing them to be processed using map algebra operations, described in Section <a href="spatial-operations.html#map-algebra">4.3.2</a>. The final Section <a href="geometric-operations.html#raster-vector">5.4</a> connects vector and raster objects.
It shows how raster values can be ‘masked’ and ‘extracted’ by vector geometries.
Importantly it shows how to ‘polygonize’ rasters and ‘rasterize’ vector datasets, making the two data models more interchangeable.</p>
</div>
<div id="geo-vec" class="section level2">
<h2><span class="header-section-number">5.2</span> Geometric operations on vector data</h2>
<p>This section is about operations that in some way change the geometry of vector (<code>sf</code>) objects.
It is more advanced than the spatial data operations presented in the previous chapter (in Section <a href="spatial-operations.html#spatial-vec">4.2</a>), because here we drill down into the geometry:
the functions discussed in this section work on objects of class <code>sfc</code> in addition to objects of class <code>sf</code>.</p>
<div id="simplification" class="section level3">
<h3><span class="header-section-number">5.2.1</span> Simplification</h3>
<p>
Simplification is a process for generalization of vector objects (lines and polygons) usually for use in smaller scale maps.
Another reason for simplifying objects is to reduce the amount of memory, disk space and network bandwidth they consume:
it may be wise to simplify complex geometries before publishing them as interactive maps.
The <strong>sf</strong> package provides <code>st_simplify()</code>, which uses the GEOS implementation of the Douglas-Peucker algorithm to reduce the vertex count.
<code>st_simplify()</code> uses the <code>dTolerance</code> to control the level of generalization in map units <span class="citation">(see Douglas and Peucker <a href="#ref-douglas_algorithms_1973" role="doc-biblioref">1973</a> for details)</span>.
<!-- I have no idea what the next sentence means -->
<!-- As a result, all vertices in the simplified geometry will be within this value from the original ones. -->
Figure <a href="geometric-operations.html#fig:seine-simp">5.1</a> illustrates simplification of a <code>LINESTRING</code> geometry representing the river Seine and tributaries.
The simplified geometry was created by the following command:</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="geometric-operations.html#cb149-1"></a>seine_simp =<span class="st"> </span><span class="kw">st_simplify</span>(seine, <span class="dt">dTolerance =</span> <span class="dv">2000</span>)  <span class="co"># 2000 m</span></span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:seine-simp"></span>
<img src="05-geometry-operations_files/figure-html/seine-simp-1.png" alt="Comparison of the original and simplified geometry of the seine object." width="100%" />
<p class="caption">
FIGURE 5.1: Comparison of the original and simplified geometry of the seine object.
</p>
</div>
<p>The resulting <code>seine_simp</code> object is a copy of the original <code>seine</code> but with fewer vertices.
This is apparent, with the result being visually simpler (Figure <a href="geometric-operations.html#fig:seine-simp">5.1</a>, right) and consuming less memory than the original object, as verified below:</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="geometric-operations.html#cb150-1"></a><span class="kw">object.size</span>(seine)</span>
<span id="cb150-2"><a href="geometric-operations.html#cb150-2"></a><span class="co">#&gt; 18096 bytes</span></span>
<span id="cb150-3"><a href="geometric-operations.html#cb150-3"></a><span class="kw">object.size</span>(seine_simp)</span>
<span id="cb150-4"><a href="geometric-operations.html#cb150-4"></a><span class="co">#&gt; 9112 bytes</span></span></code></pre></div>
<p>Simplification is also applicable for polygons.
This is illustrated using <code>us_states</code>, representing the contiguous United States.
As we show in Chapter <a href="reproj-geo-data.html#reproj-geo-data">6</a>, GEOS assumes that the data is in a projected CRS and this could lead to unexpected results when using a geographic CRS.
Therefore, the first step is to project the data into some adequate projected CRS, such as US National Atlas Equal Area (epsg = 2163) (on the left in Figure <a href="geometric-operations.html#fig:us-simp">5.2</a>):</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="geometric-operations.html#cb151-1"></a>us_states2163 =<span class="st"> </span><span class="kw">st_transform</span>(us_states, <span class="dv">2163</span>)</span></code></pre></div>
<p><code>st_simplify()</code> works equally well with projected polygons:</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="geometric-operations.html#cb152-1"></a>us_states_simp1 =<span class="st"> </span><span class="kw">st_simplify</span>(us_states2163, <span class="dt">dTolerance =</span> <span class="dv">100000</span>)  <span class="co"># 100 km</span></span></code></pre></div>
<p>A limitation with <code>st_simplify()</code> is that it simplifies objects on a per-geometry basis.
This means the ‘topology’ is lost, resulting in overlapping and ‘holy’ areal units illustrated in Figure <a href="geometric-operations.html#fig:us-simp">5.2</a> (middle panel).
<code>ms_simplify()</code> from <strong>rmapshaper</strong> provides an alternative that overcomes this issue.
By default it uses the Visvalingam algorithm, which overcomes some limitations of the Douglas-Peucker algorithm <span class="citation">(Visvalingam and Whyatt <a href="#ref-visvalingam_line_1993" role="doc-biblioref">1993</a>)</span>.
<!-- https://bost.ocks.org/mike/simplify/ -->
The following code chunk uses this function to simplify <code>us_states2163</code>.
The result has only 1% of the vertices of the input (set using the argument <code>keep</code>) but its number of objects remains intact because we set <code>keep_shapes = TRUE</code>:<a href="#fn19" class="footnote-ref" id="fnref19"><sup>19</sup></a></p>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="geometric-operations.html#cb153-1"></a><span class="co"># proportion of points to retain (0-1; default 0.05)</span></span>
<span id="cb153-2"><a href="geometric-operations.html#cb153-2"></a>us_states2163<span class="op">$</span>AREA =<span class="st"> </span><span class="kw">as.numeric</span>(us_states2163<span class="op">$</span>AREA)</span>
<span id="cb153-3"><a href="geometric-operations.html#cb153-3"></a>us_states_simp2 =<span class="st"> </span>rmapshaper<span class="op">::</span><span class="kw">ms_simplify</span>(us_states2163, <span class="dt">keep =</span> <span class="fl">0.01</span>,</span>
<span id="cb153-4"><a href="geometric-operations.html#cb153-4"></a>                                          <span class="dt">keep_shapes =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p>Finally, the visual comparison of the original dataset and the two simplified versions shows differences between the Douglas-Peucker (<code>st_simplify</code>) and Visvalingam (<code>ms_simplify</code>) algorithm outputs (Figure <a href="geometric-operations.html#fig:us-simp">5.2</a>):</p>
<div class="figure" style="text-align: center"><span id="fig:us-simp"></span>
<img src="05-geometry-operations_files/figure-html/us-simp-1.png" alt="Polygon simplification in action, comparing the original geometry of the contiguous United States with simplified versions, generated with functions from sf (center) and rmapshaper (right) packages." width="100%" />
<p class="caption">
FIGURE 5.2: Polygon simplification in action, comparing the original geometry of the contiguous United States with simplified versions, generated with functions from sf (center) and rmapshaper (right) packages.
</p>
</div>
</div>
<div id="centroids" class="section level3">
<h3><span class="header-section-number">5.2.2</span> Centroids</h3>
<p>
Centroid operations identify the center of geographic objects.
Like statistical measures of central tendency (including mean and median definitions of ‘average’), there are many ways to define the geographic center of an object.
All of them create single point representations of more complex vector objects.</p>
<p>The most commonly used centroid operation is the <em>geographic centroid</em>.
This type of centroid operation (often referred to as ‘the centroid’) represents the center of mass in a spatial object (think of balancing a plate on your finger).
Geographic centroids have many uses, for example to create a simple point representation of complex geometries, or to estimate distances between polygons.
They can be calculated with the <strong>sf</strong> function <code>st_centroid()</code> as demonstrated in the code below, which generates the geographic centroids of regions in New Zealand and tributaries to the River Seine, illustrated with black points in Figure <a href="geometric-operations.html#fig:centr">5.3</a>.</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="geometric-operations.html#cb154-1"></a>nz_centroid =<span class="st"> </span><span class="kw">st_centroid</span>(nz)</span>
<span id="cb154-2"><a href="geometric-operations.html#cb154-2"></a>seine_centroid =<span class="st"> </span><span class="kw">st_centroid</span>(seine)</span></code></pre></div>
<p>Sometimes the geographic centroid falls outside the boundaries of their parent objects (think of a doughnut).
In such cases <em>point on surface</em> operations can be used to guarantee the point will be in the parent object (e.g., for labeling irregular multipolygon objects such as island states), as illustrated by the red points in Figure <a href="geometric-operations.html#fig:centr">5.3</a>.
Notice that these red points always lie on their parent objects.
They were created with <code>st_point_on_surface()</code> as follows:<a href="#fn20" class="footnote-ref" id="fnref20"><sup>20</sup></a></p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="geometric-operations.html#cb155-1"></a>nz_pos =<span class="st"> </span><span class="kw">st_point_on_surface</span>(nz)</span>
<span id="cb155-2"><a href="geometric-operations.html#cb155-2"></a>seine_pos =<span class="st"> </span><span class="kw">st_point_on_surface</span>(seine)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:centr"></span>
<img src="05-geometry-operations_files/figure-html/centr-1.png" alt="Centroids (black points) and 'points on surface' (red points) of New Zealand's regions (left) and the Seine (right) datasets." width="100%" />
<p class="caption">
FIGURE 5.3: Centroids (black points) and ‘points on surface’ (red points) of New Zealand’s regions (left) and the Seine (right) datasets.
</p>
</div>
<p>Other types of centroids exist, including the <em>Chebyshev center</em> and the <em>visual center</em>.
We will not explore these here but it is possible to calculate them using R, as we’ll see in Chapter <a href="algorithms.html#algorithms">10</a>.</p>
</div>
<div id="buffers" class="section level3">
<h3><span class="header-section-number">5.2.3</span> Buffers</h3>
<p>
Buffers are polygons representing the area within a given distance of a geometric feature:
regardless of whether the input is a point, line or polygon, the output is a polygon.
Unlike simplification (which is often used for visualization and reducing file size) buffering tends to be used for geographic data analysis.
How many points are within a given distance of this line?
Which demographic groups are within travel distance of this new shop?
These kinds of questions can be answered and visualized by creating buffers around the geographic entities of interest.</p>
<p>Figure <a href="geometric-operations.html#fig:buffs">5.4</a> illustrates buffers of different sizes (5 and 50 km) surrounding the river Seine and tributaries.
These buffers were created with commands below, which show that the command <code>st_buffer()</code> requires at least two arguments: an input geometry and a distance, provided in the units of the CRS (in this case meters):</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="geometric-operations.html#cb156-1"></a>seine_buff_5km =<span class="st"> </span><span class="kw">st_buffer</span>(seine, <span class="dt">dist =</span> <span class="dv">5000</span>)</span>
<span id="cb156-2"><a href="geometric-operations.html#cb156-2"></a>seine_buff_50km =<span class="st"> </span><span class="kw">st_buffer</span>(seine, <span class="dt">dist =</span> <span class="dv">50000</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:buffs"></span>
<img src="05-geometry-operations_files/figure-html/buffs-1.png" alt="Buffers around the Seine dataset of 5 km (left) and 50 km (right). Note the colors, which reflect the fact that one buffer is created per geometry feature." width="75%" />
<p class="caption">
FIGURE 5.4: Buffers around the Seine dataset of 5 km (left) and 50 km (right). Note the colors, which reflect the fact that one buffer is created per geometry feature.
</p>
</div>

<div class="rmdnote">
The third and final argument of <code>st_buffer()</code> is <code>nQuadSegs</code>, which means ‘number of segments per quadrant’ and is set by default to 30 (meaning circles created by buffers are composed of <span class="math inline">\(4 \times 30 = 120\)</span> lines).
This argument rarely needs to be set.
Unusual cases where it may be useful include when the memory consumed by the output of a buffer operation is a major concern (in which case it should be reduced) or when very high precision is needed (in which case it should be increased).
</div>

</div>
<div id="affine-transformations" class="section level3">
<h3><span class="header-section-number">5.2.4</span> Affine transformations</h3>
<p>
Affine transformation is any transformation that preserves lines and parallelism.
<!-- The midpoint of a line segment remains a midpoint and all points lying on a line initially still lie on a line after an affine transformation. -->
However, angles or length are not necessarily preserved.
Affine transformations include, among others, shifting (translation), scaling and rotation.
<!-- translation, scaling, homothety, similarity transformation, reflection, rotation, shear mapping -->
Additionally, it is possible to use any combination of these.
Affine transformations are an essential part of geocomputation.
For example, shifting is needed for labels placement, scaling is used in non-contiguous area cartograms (see Section <a href="adv-map.html#other-mapping-packages">8.6</a>), and many affine transformations are applied when reprojecting or improving the geometry that was created based on a distorted or wrongly projected map.
The <strong>sf</strong> package implements affine transformation for objects of classes <code>sfg</code> and <code>sfc</code>.</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="geometric-operations.html#cb157-1"></a>nz_sfc =<span class="st"> </span><span class="kw">st_geometry</span>(nz)</span></code></pre></div>
<p>Shifting moves every point by the same distance in map units.
It could be done by adding a numerical vector to a vector object.
For example, the code below shifts all y-coordinates by 100,000 meters to the north, but leaves the x-coordinates untouched (left panel of Figure <a href="geometric-operations.html#fig:affine-trans">5.5</a>).</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="geometric-operations.html#cb158-1"></a>nz_shift =<span class="st"> </span>nz_sfc <span class="op">+</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">100000</span>)</span></code></pre></div>
<p>Scaling enlarges or shrinks objects by a factor.
It can be applied either globally or locally. <!-- my terms - jn-->
Global scaling increases or decreases all coordinates values in relation to the origin coordinates, while keeping all geometries topological relations intact.
It can be done by subtraction or multiplication of a<code>sfg</code> or <code>sfc</code> object.</p>
<p>Local scaling treats geometries independently and requires points around which geometries are going to be scaled, e.g., centroids.
In the example below, each geometry is shrunk by a factor of two around the centroids (middle panel in Figure <a href="geometric-operations.html#fig:affine-trans">5.5</a>).
To achieve that, each object is firstly shifted in a way that its center has coordinates of <code>0, 0</code> (<code>(nz_sfc - nz_centroid_sfc)</code>).
Next, the sizes of the geometries are reduced by half (<code>* 0.5</code>).
Finally, each object’s centroid is moved back to the input data coordinates (<code>+ nz_centroid_sfc</code>).</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="geometric-operations.html#cb159-1"></a>nz_centroid_sfc =<span class="st"> </span><span class="kw">st_centroid</span>(nz_sfc)</span>
<span id="cb159-2"><a href="geometric-operations.html#cb159-2"></a>nz_scale =<span class="st"> </span>(nz_sfc <span class="op">-</span><span class="st"> </span>nz_centroid_sfc) <span class="op">*</span><span class="st"> </span><span class="fl">0.5</span> <span class="op">+</span><span class="st"> </span>nz_centroid_sfc</span></code></pre></div>
<p>Rotation of two-dimensional coordinates requires a rotation matrix:</p>
<p><span class="math display">\[
R =
\begin{bmatrix}
\cos \theta &amp; -\sin \theta \\  
\sin \theta &amp; \cos \theta \\
\end{bmatrix}
\]</span></p>
<p>It rotates points in a clockwise direction.
The rotation matrix can be implemented in R as:
<!-- https://r-spatial.github.io/sf/articles/sf3.html#affine-transformations --></p>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="geometric-operations.html#cb160-1"></a>rotation =<span class="st"> </span><span class="cf">function</span>(a){</span>
<span id="cb160-2"><a href="geometric-operations.html#cb160-2"></a>  r =<span class="st"> </span>a <span class="op">*</span><span class="st"> </span>pi <span class="op">/</span><span class="st"> </span><span class="dv">180</span> <span class="co">#degrees to radians</span></span>
<span id="cb160-3"><a href="geometric-operations.html#cb160-3"></a>  <span class="kw">matrix</span>(<span class="kw">c</span>(<span class="kw">cos</span>(r), <span class="kw">sin</span>(r), <span class="op">-</span><span class="kw">sin</span>(r), <span class="kw">cos</span>(r)), <span class="dt">nrow =</span> <span class="dv">2</span>, <span class="dt">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb160-4"><a href="geometric-operations.html#cb160-4"></a>} </span></code></pre></div>
<p>The <code>rotation</code> function accepts one argument <code>a</code> - a rotation angle in degrees.
Rotation could be done around selected points, such as centroids (right panel of Figure <a href="geometric-operations.html#fig:affine-trans">5.5</a>).
See <code>vignette("sf3")</code> for more examples.</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="geometric-operations.html#cb161-1"></a>nz_rotate =<span class="st"> </span>(nz_sfc <span class="op">-</span><span class="st"> </span>nz_centroid_sfc) <span class="op">*</span><span class="st"> </span><span class="kw">rotation</span>(<span class="dv">30</span>) <span class="op">+</span><span class="st"> </span>nz_centroid_sfc</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:affine-trans"></span>
<img src="05-geometry-operations_files/figure-html/affine-trans-1.png" alt="Illustrations of affine transformations: shift, scale and rotate." width="100%" />
<p class="caption">
FIGURE 5.5: Illustrations of affine transformations: shift, scale and rotate.
</p>
</div>
<p>Finally, the newly created geometries can replace the old ones with the <code>st_set_geometry()</code> function:</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="geometric-operations.html#cb162-1"></a>nz_scale_sf =<span class="st"> </span><span class="kw">st_set_geometry</span>(nz, nz_scale)</span></code></pre></div>
</div>
<div id="clipping" class="section level3">
<h3><span class="header-section-number">5.2.5</span> Clipping</h3>
<p>

Spatial clipping is a form of spatial subsetting that involves changes to the <code>geometry</code> columns of at least some of the affected features.</p>
<p>Clipping can only apply to features more complex than points:
lines, polygons and their ‘multi’ equivalents.
To illustrate the concept we will start with a simple example:
two overlapping circles with a center point one unit away from each other and a radius of one (Figure <a href="geometric-operations.html#fig:points">5.6</a>).</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="geometric-operations.html#cb163-1"></a>b =<span class="st"> </span><span class="kw">st_sfc</span>(<span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)), <span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))) <span class="co"># create 2 points</span></span>
<span id="cb163-2"><a href="geometric-operations.html#cb163-2"></a>b =<span class="st"> </span><span class="kw">st_buffer</span>(b, <span class="dt">dist =</span> <span class="dv">1</span>) <span class="co"># convert points to circles</span></span>
<span id="cb163-3"><a href="geometric-operations.html#cb163-3"></a><span class="kw">plot</span>(b)</span>
<span id="cb163-4"><a href="geometric-operations.html#cb163-4"></a><span class="kw">text</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="op">-</span><span class="fl">0.5</span>, <span class="fl">1.5</span>), <span class="dt">y =</span> <span class="dv">1</span>, <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>)) <span class="co"># add text</span></span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:points"></span>
<img src="05-geometry-operations_files/figure-html/points-1.png" alt="Overlapping circles." width="50%" />
<p class="caption">
FIGURE 5.6: Overlapping circles.
</p>
</div>
<p>Imagine you want to select not one circle or the other, but the space covered by both <code>x</code> <em>and</em> <code>y</code>.
This can be done using the function <code>st_intersection()</code>, illustrated using objects named <code>x</code> and <code>y</code> which represent the left- and right-hand circles (Figure <a href="geometric-operations.html#fig:circle-intersection">5.7</a>).</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="geometric-operations.html#cb164-1"></a>x =<span class="st"> </span>b[<span class="dv">1</span>]</span>
<span id="cb164-2"><a href="geometric-operations.html#cb164-2"></a>y =<span class="st"> </span>b[<span class="dv">2</span>]</span>
<span id="cb164-3"><a href="geometric-operations.html#cb164-3"></a>x_and_y =<span class="st"> </span><span class="kw">st_intersection</span>(x, y)</span>
<span id="cb164-4"><a href="geometric-operations.html#cb164-4"></a><span class="kw">plot</span>(b)</span>
<span id="cb164-5"><a href="geometric-operations.html#cb164-5"></a><span class="kw">plot</span>(x_and_y, <span class="dt">col =</span> <span class="st">&quot;lightgrey&quot;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>) <span class="co"># color intersecting area</span></span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:circle-intersection"></span>
<img src="05-geometry-operations_files/figure-html/circle-intersection-1.png" alt="Overlapping circles with a gray color indicating intersection between them." width="50%" />
<p class="caption">
FIGURE 5.7: Overlapping circles with a gray color indicating intersection between them.
</p>
</div>
<p>The subsequent code chunk demonstrates how this works for all combinations of the ‘Venn’ diagram representing <code>x</code> and <code>y</code>, inspired by <a href="http://r4ds.had.co.nz/transform.html#logical-operators">Figure 5.1</a> of the book <em>R for Data Science</em> <span class="citation">(Grolemund and Wickham <a href="#ref-grolemund_r_2016" role="doc-biblioref">2016</a>)</span>.
<!-- Todo: reference r4ds --></p>
<div class="figure" style="text-align: center"><span id="fig:venn-clip"></span>
<img src="05-geometry-operations_files/figure-html/venn-clip-1.png" alt="Spatial equivalents of logical operators." width="100%" />
<p class="caption">
FIGURE 5.8: Spatial equivalents of logical operators.
</p>
</div>
<p>To illustrate the relationship between subsetting and clipping spatial data, we will subset points that cover the bounding box of the circles <code>x</code> and <code>y</code> in Figure <a href="geometric-operations.html#fig:venn-clip">5.8</a>.
Some points will be inside just one circle, some will be inside both and some will be inside neither.
<code>st_sample()</code> is used below to generate a <em>simple random</em> distribution of points within the extent of circles <code>x</code> and <code>y</code>, resulting in output illustrated in Figure <a href="geometric-operations.html#fig:venn-subset">5.9</a>.</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="geometric-operations.html#cb165-1"></a>bb =<span class="st"> </span><span class="kw">st_bbox</span>(<span class="kw">st_union</span>(x, y))</span>
<span id="cb165-2"><a href="geometric-operations.html#cb165-2"></a>box =<span class="st"> </span><span class="kw">st_as_sfc</span>(bb)</span>
<span id="cb165-3"><a href="geometric-operations.html#cb165-3"></a><span class="kw">set.seed</span>(<span class="dv">2017</span>)</span>
<span id="cb165-4"><a href="geometric-operations.html#cb165-4"></a>p =<span class="st"> </span><span class="kw">st_sample</span>(<span class="dt">x =</span> box, <span class="dt">size =</span> <span class="dv">10</span>)</span>
<span id="cb165-5"><a href="geometric-operations.html#cb165-5"></a><span class="kw">plot</span>(box)</span>
<span id="cb165-6"><a href="geometric-operations.html#cb165-6"></a><span class="kw">plot</span>(x, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb165-7"><a href="geometric-operations.html#cb165-7"></a><span class="kw">plot</span>(y, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb165-8"><a href="geometric-operations.html#cb165-8"></a><span class="kw">plot</span>(p, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb165-9"><a href="geometric-operations.html#cb165-9"></a><span class="kw">text</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="op">-</span><span class="fl">0.5</span>, <span class="fl">1.5</span>), <span class="dt">y =</span> <span class="dv">1</span>, <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>))</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:venn-subset"></span>
<img src="05-geometry-operations_files/figure-html/venn-subset-1.png" alt="Randomly distributed points within the bounding box enclosing circles x and y." width="50%" />
<p class="caption">
FIGURE 5.9: Randomly distributed points within the bounding box enclosing circles x and y.
</p>
</div>
<p>The logical operator way would find the points inside both <code>x</code> and <code>y</code> using a spatial predicate such as <code>st_intersects()</code>, whereas the intersection method simply finds the points inside the intersecting region created above as <code>x_and_y</code>.
As demonstrated below the results are identical, but the method that uses the clipped polygon is more concise:</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="geometric-operations.html#cb166-1"></a>sel_p_xy =<span class="st"> </span><span class="kw">st_intersects</span>(p, x, <span class="dt">sparse =</span> <span class="ot">FALSE</span>)[, <span class="dv">1</span>] <span class="op">&amp;</span></span>
<span id="cb166-2"><a href="geometric-operations.html#cb166-2"></a><span class="st">  </span><span class="kw">st_intersects</span>(p, y, <span class="dt">sparse =</span> <span class="ot">FALSE</span>)[, <span class="dv">1</span>]</span>
<span id="cb166-3"><a href="geometric-operations.html#cb166-3"></a>p_xy1 =<span class="st"> </span>p[sel_p_xy]</span>
<span id="cb166-4"><a href="geometric-operations.html#cb166-4"></a>p_xy2 =<span class="st"> </span>p[x_and_y]</span>
<span id="cb166-5"><a href="geometric-operations.html#cb166-5"></a><span class="kw">identical</span>(p_xy1, p_xy2)</span>
<span id="cb166-6"><a href="geometric-operations.html#cb166-6"></a><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
<div id="geometry-unions" class="section level3">
<h3><span class="header-section-number">5.2.6</span> Geometry unions</h3>
<p>

As we saw in Section <a href="attr.html#vector-attribute-aggregation">3.2.2</a>, spatial aggregation can silently dissolve the geometries of touching polygons in the same group.
This is demonstrated in the code chunk below in which 49 <code>us_states</code> are aggregated into 4 regions using base and <strong>tidyverse</strong> functions (see results in Figure <a href="geometric-operations.html#fig:us-regions">5.10</a>):</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="geometric-operations.html#cb167-1"></a>regions =<span class="st"> </span><span class="kw">aggregate</span>(<span class="dt">x =</span> us_states[, <span class="st">&quot;total_pop_15&quot;</span>], <span class="dt">by =</span> <span class="kw">list</span>(us_states<span class="op">$</span>REGION),</span>
<span id="cb167-2"><a href="geometric-operations.html#cb167-2"></a>                    <span class="dt">FUN =</span> sum, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span>
<span id="cb167-3"><a href="geometric-operations.html#cb167-3"></a>regions2 =<span class="st"> </span>us_states <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(REGION) <span class="op">%&gt;%</span></span>
<span id="cb167-4"><a href="geometric-operations.html#cb167-4"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">pop =</span> <span class="kw">sum</span>(total_pop_<span class="dv">15</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</span>
<span id="cb167-5"><a href="geometric-operations.html#cb167-5"></a><span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span></span>
<span id="cb167-6"><a href="geometric-operations.html#cb167-6"></a><span class="co">#&gt; although coordinates are longitude/latitude, st_union assumes that they are planar</span></span>
<span id="cb167-7"><a href="geometric-operations.html#cb167-7"></a><span class="co">#&gt; although coordinates are longitude/latitude, st_union assumes that they are planar</span></span>
<span id="cb167-8"><a href="geometric-operations.html#cb167-8"></a><span class="co">#&gt; although coordinates are longitude/latitude, st_union assumes that they are planar</span></span>
<span id="cb167-9"><a href="geometric-operations.html#cb167-9"></a><span class="co">#&gt; although coordinates are longitude/latitude, st_union assumes that they are planar</span></span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:us-regions"></span>
<img src="05-geometry-operations_files/figure-html/us-regions-1.png" alt="Spatial aggregation on contiguous polygons, illustrated by aggregating the population of US states into regions, with population represented by color. Note the operation automatically dissolves boundaries between states." width="100%" />
<p class="caption">
FIGURE 5.10: Spatial aggregation on contiguous polygons, illustrated by aggregating the population of US states into regions, with population represented by color. Note the operation automatically dissolves boundaries between states.
</p>
</div>
<p>What is going on in terms of the geometries?
Behind the scenes, both <code>aggregate()</code> and <code>summarize()</code> combine the geometries and dissolve the boundaries between them using <code>st_union()</code>.
This is demonstrated in the code chunk below which creates a united western US:</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="geometric-operations.html#cb168-1"></a>us_west =<span class="st"> </span>us_states[us_states<span class="op">$</span>REGION <span class="op">==</span><span class="st"> &quot;West&quot;</span>, ]</span>
<span id="cb168-2"><a href="geometric-operations.html#cb168-2"></a>us_west_union =<span class="st"> </span><span class="kw">st_union</span>(us_west)</span>
<span id="cb168-3"><a href="geometric-operations.html#cb168-3"></a><span class="co">#&gt; although coordinates are longitude/latitude, st_union assumes that they are planar</span></span></code></pre></div>
<p>The function can take two geometries and unite them, as demonstrated in the code chunk below which creates a united western block incorporating Texas (challenge: reproduce and plot the result):</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="geometric-operations.html#cb169-1"></a>texas =<span class="st"> </span>us_states[us_states<span class="op">$</span>NAME <span class="op">==</span><span class="st"> &quot;Texas&quot;</span>, ]</span>
<span id="cb169-2"><a href="geometric-operations.html#cb169-2"></a>texas_union =<span class="st"> </span><span class="kw">st_union</span>(us_west_union, texas)</span></code></pre></div>
</div>
<div id="type-trans" class="section level3">
<h3><span class="header-section-number">5.2.7</span> Type transformations</h3>
<p>
Geometry casting is a powerful operation that enables transformation of the geometry type.
It is implemented in the <code>st_cast</code> function from the <strong>sf</strong> package.
Importantly, <code>st_cast</code> behaves differently on single simple feature geometry (<code>sfg</code>) objects, simple feature geometry column (<code>sfc</code>) and simple features objects.</p>
<p>Let’s create a multipoint to illustrate how geometry casting works on simple feature geometry (<code>sfg</code>) objects:</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="geometric-operations.html#cb170-1"></a>multipoint =<span class="st"> </span><span class="kw">st_multipoint</span>(<span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">1</span>), <span class="dt">ncol =</span> <span class="dv">2</span>))</span></code></pre></div>
<p>In this case, <code>st_cast</code> can be useful to transform the new object into linestring or polygon (Figure <a href="geometric-operations.html#fig:single-cast">5.11</a>):</p>
<!-- a/ points -> lines -> polygons  -->
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="geometric-operations.html#cb171-1"></a>linestring =<span class="st"> </span><span class="kw">st_cast</span>(multipoint, <span class="st">&quot;LINESTRING&quot;</span>)</span>
<span id="cb171-2"><a href="geometric-operations.html#cb171-2"></a>polyg =<span class="st"> </span><span class="kw">st_cast</span>(multipoint, <span class="st">&quot;POLYGON&quot;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:single-cast"></span>
<img src="05-geometry-operations_files/figure-html/single-cast-1.png" alt="Examples of linestring and polygon casted from a multipoint geometry." width="100%" />
<p class="caption">
FIGURE 5.11: Examples of linestring and polygon casted from a multipoint geometry.
</p>
</div>
<p>Conversion from multipoint to linestring is a common operation that creates a line object from ordered point observations, such as GPS measurements or geotagged media.
This allows spatial operations such as the length of the path traveled.
Conversion from multipoint or linestring to polygon is often used to calculate an area, for example from the set of GPS measurements taken around a lake or from the corners of a building lot.</p>
<p>The transformation process can be also reversed using <code>st_cast</code>:</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="geometric-operations.html#cb172-1"></a>multipoint_<span class="dv">2</span> =<span class="st"> </span><span class="kw">st_cast</span>(linestring, <span class="st">&quot;MULTIPOINT&quot;</span>)</span>
<span id="cb172-2"><a href="geometric-operations.html#cb172-2"></a>multipoint_<span class="dv">3</span> =<span class="st"> </span><span class="kw">st_cast</span>(polyg, <span class="st">&quot;MULTIPOINT&quot;</span>)</span>
<span id="cb172-3"><a href="geometric-operations.html#cb172-3"></a><span class="kw">all.equal</span>(multipoint, multipoint_<span class="dv">2</span>, multipoint_<span class="dv">3</span>)</span>
<span id="cb172-4"><a href="geometric-operations.html#cb172-4"></a><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>

<div class="rmdnote">
For single simple feature geometries (<code>sfg</code>), <code>st_cast</code> also provides geometry casting from non-multi-types to multi-types (e.g., <code>POINT</code> to <code>MULTIPOINT</code>) and from multi-types to non-multi-types.
However, only the first element of the old object would remain in the second group of cases.
</div>

<p>Geometry casting of simple features geometry column (<code>sfc</code>) and simple features objects works the same as for single geometries in most of the cases.
One important difference is the conversion between multi-types to non-multi-types.
As a result of this process, multi-objects are split into many non-multi-objects.</p>
<p>Table <a href="geometric-operations.html#tab:sfs-st-cast">5.1</a> shows possible geometry type transformations on simple feature objects.
Each input simple feature object with only one element (first column) is transformed directly into another geometry type.
Several of the transformations are not possible, for example, you cannot convert a single point into a multilinestring or a polygon (so the cells <code>[1, 4:5]</code> in the table are NA).
On the other hand, some of the transformations are splitting the single element input object into a multi-element object.
You can see that, for example, when you cast a multipoint consisting of five pairs of coordinates into a point.</p>
<table>
<caption>
<span id="tab:sfs-st-cast">TABLE 5.1: </span>Geometry casting on simple feature geometries (see Section 2.1) with input type by row and output type by column
</caption>
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
POI
</th>
<th style="text-align:right;">
MPOI
</th>
<th style="text-align:right;">
LIN
</th>
<th style="text-align:right;">
MLIN
</th>
<th style="text-align:right;">
POL
</th>
<th style="text-align:right;">
MPOL
</th>
<th style="text-align:right;">
GC
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
POI(1)
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:left;">
MPOI(1)
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:left;">
LIN(1)
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:left;">
MLIN(1)
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:left;">
POL(1)
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:left;">
MPOL(1)
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
GC(1)
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
<tfoot>
<tr>
<td style="padding: 0; border:0;" colspan="100%">
<sup></sup> Note: Values like (1) represent the number of features; NA means the operation is not possible. Abbreviations: POI, LIN, POL and GC refer to POINT, LINESTRING, POLYGON and GEOMETRYCOLLECTION. The MULTI version of these geometry types is indicated by a preceding M, e.g., MPOI is the acronym for MULTIPOINT.
</td>
</tr>
</tfoot>
</table>
<p>Let’s try to apply geometry type transformations on a new object, <code>multilinestring_sf</code>, as an example (on the left in Figure <a href="geometric-operations.html#fig:line-cast">5.12</a>):</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb173-1"><a href="geometric-operations.html#cb173-1"></a>multilinestring_list =<span class="st"> </span><span class="kw">list</span>(<span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">3</span>), <span class="dt">ncol =</span> <span class="dv">2</span>), </span>
<span id="cb173-2"><a href="geometric-operations.html#cb173-2"></a>                            <span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">1</span>), <span class="dt">ncol =</span> <span class="dv">2</span>),</span>
<span id="cb173-3"><a href="geometric-operations.html#cb173-3"></a>                            <span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">2</span>), <span class="dt">ncol =</span> <span class="dv">2</span>))</span>
<span id="cb173-4"><a href="geometric-operations.html#cb173-4"></a>multilinestring =<span class="st"> </span><span class="kw">st_multilinestring</span>((multilinestring_list))</span>
<span id="cb173-5"><a href="geometric-operations.html#cb173-5"></a>multilinestring_sf =<span class="st"> </span><span class="kw">st_sf</span>(<span class="dt">geom =</span> <span class="kw">st_sfc</span>(multilinestring))</span>
<span id="cb173-6"><a href="geometric-operations.html#cb173-6"></a>multilinestring_sf</span>
<span id="cb173-7"><a href="geometric-operations.html#cb173-7"></a><span class="co">#&gt; Simple feature collection with 1 feature and 0 fields</span></span>
<span id="cb173-8"><a href="geometric-operations.html#cb173-8"></a><span class="co">#&gt; geometry type:  MULTILINESTRING</span></span>
<span id="cb173-9"><a href="geometric-operations.html#cb173-9"></a><span class="co">#&gt; dimension:      XY</span></span>
<span id="cb173-10"><a href="geometric-operations.html#cb173-10"></a><span class="co">#&gt; bbox:           xmin: 1 ymin: 1 xmax: 4 ymax: 5</span></span>
<span id="cb173-11"><a href="geometric-operations.html#cb173-11"></a><span class="co">#&gt; CRS:            NA</span></span>
<span id="cb173-12"><a href="geometric-operations.html#cb173-12"></a><span class="co">#&gt;                             geom</span></span>
<span id="cb173-13"><a href="geometric-operations.html#cb173-13"></a><span class="co">#&gt; 1 MULTILINESTRING ((1 5, 4 3)...</span></span></code></pre></div>
<p>You can imagine it as a road or river network.
The new object has only one row that defines all the lines.
This restricts the number of operations that can be done, for example it prevents adding names to each line segment or calculating lengths of single lines.
The <code>st_cast</code> function can be used in this situation, as it separates one mutlilinestring into three linestrings:</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb174-1"><a href="geometric-operations.html#cb174-1"></a>linestring_sf2 =<span class="st"> </span><span class="kw">st_cast</span>(multilinestring_sf, <span class="st">&quot;LINESTRING&quot;</span>)</span>
<span id="cb174-2"><a href="geometric-operations.html#cb174-2"></a>linestring_sf2</span>
<span id="cb174-3"><a href="geometric-operations.html#cb174-3"></a><span class="co">#&gt; Simple feature collection with 3 features and 0 fields</span></span>
<span id="cb174-4"><a href="geometric-operations.html#cb174-4"></a><span class="co">#&gt; geometry type:  LINESTRING</span></span>
<span id="cb174-5"><a href="geometric-operations.html#cb174-5"></a><span class="co">#&gt; dimension:      XY</span></span>
<span id="cb174-6"><a href="geometric-operations.html#cb174-6"></a><span class="co">#&gt; bbox:           xmin: 1 ymin: 1 xmax: 4 ymax: 5</span></span>
<span id="cb174-7"><a href="geometric-operations.html#cb174-7"></a><span class="co">#&gt; CRS:            NA</span></span>
<span id="cb174-8"><a href="geometric-operations.html#cb174-8"></a><span class="co">#&gt;                    geom</span></span>
<span id="cb174-9"><a href="geometric-operations.html#cb174-9"></a><span class="co">#&gt; 1 LINESTRING (1 5, 4 3)</span></span>
<span id="cb174-10"><a href="geometric-operations.html#cb174-10"></a><span class="co">#&gt; 2 LINESTRING (4 4, 4 1)</span></span>
<span id="cb174-11"><a href="geometric-operations.html#cb174-11"></a><span class="co">#&gt; 3 LINESTRING (2 2, 4 2)</span></span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:line-cast"></span>
<img src="05-geometry-operations_files/figure-html/line-cast-1.png" alt="Examples of type casting between MULTILINESTRING (left) and LINESTRING (right)." width="100%" />
<p class="caption">
FIGURE 5.12: Examples of type casting between MULTILINESTRING (left) and LINESTRING (right).
</p>
</div>
<p>The newly created object allows for attributes creation (see more in Section <a href="attr.html#vec-attr-creation">3.2.4</a>) and length measurements:</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="geometric-operations.html#cb175-1"></a>linestring_sf2<span class="op">$</span>name =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Riddle Rd&quot;</span>, <span class="st">&quot;Marshall Ave&quot;</span>, <span class="st">&quot;Foulke St&quot;</span>)</span>
<span id="cb175-2"><a href="geometric-operations.html#cb175-2"></a>linestring_sf2<span class="op">$</span>length =<span class="st"> </span><span class="kw">st_length</span>(linestring_sf2)</span>
<span id="cb175-3"><a href="geometric-operations.html#cb175-3"></a>linestring_sf2</span>
<span id="cb175-4"><a href="geometric-operations.html#cb175-4"></a><span class="co">#&gt; Simple feature collection with 3 features and 2 fields</span></span>
<span id="cb175-5"><a href="geometric-operations.html#cb175-5"></a><span class="co">#&gt; geometry type:  LINESTRING</span></span>
<span id="cb175-6"><a href="geometric-operations.html#cb175-6"></a><span class="co">#&gt; dimension:      XY</span></span>
<span id="cb175-7"><a href="geometric-operations.html#cb175-7"></a><span class="co">#&gt; bbox:           xmin: 1 ymin: 1 xmax: 4 ymax: 5</span></span>
<span id="cb175-8"><a href="geometric-operations.html#cb175-8"></a><span class="co">#&gt; CRS:            NA</span></span>
<span id="cb175-9"><a href="geometric-operations.html#cb175-9"></a><span class="co">#&gt;                    geom         name length</span></span>
<span id="cb175-10"><a href="geometric-operations.html#cb175-10"></a><span class="co">#&gt; 1 LINESTRING (1 5, 4 3)    Riddle Rd   3.61</span></span>
<span id="cb175-11"><a href="geometric-operations.html#cb175-11"></a><span class="co">#&gt; 2 LINESTRING (4 4, 4 1) Marshall Ave   3.00</span></span>
<span id="cb175-12"><a href="geometric-operations.html#cb175-12"></a><span class="co">#&gt; 3 LINESTRING (2 2, 4 2)    Foulke St   2.00</span></span></code></pre></div>
<!-- idea: example where a collection of points referring to different objects are combined to MULTIPOINT by object, then casted to LINESTRING geometries per object -->
</div>
</div>
<div id="geo-ras" class="section level2">
<h2><span class="header-section-number">5.3</span> Geometric operations on raster data</h2>
<p>
Geometric raster operations include the shift, flipping, mirroring, scaling, rotation or warping of images.
These operations are necessary for a variety of applications including georeferencing, used to allow images to be overlaid on an accurate map with a known CRS <span class="citation">(Liu and Mason <a href="#ref-liu_essential_2009" role="doc-biblioref">2009</a>)</span>.
A variety of georeferencing techniques exist, including</p>
<ul>
<li>georectification based on known <a href="http://www.qgistutorials.com/en/docs/georeferencing_basics.html">ground control points</a>;</li>
<li>orthorectification, which also accounts for local topography; and</li>
<li>image <a href="https://en.wikipedia.org/wiki/Image_registration">registration</a> is used to combine images of the same thing but shot from different sensors the process of aligning one image with another (in terms of coordinate system, and resolution).</li>
</ul>
<p>R is unsuitable for the first two points since these often require manual intervention which is why they are usually done with the help of dedicated GIS software (see also Chapter <a href="gis.html#gis">9</a>).
On the other hand, aligning several images is possible in R and this section shows among others how to do so.
This often includes changing the extent, the resolution and the origin of an image.
A matching projection is of course also required but is already covered in Section <a href="reproj-geo-data.html#reprojecting-raster-geometries">6.6</a>.
In any case, there are other reasons to perform a geometric operation on a single raster image.
For instance, in Chapter <a href="location.html#location">13</a> we define metropolitan areas in Germany as 20 km<sup>2</sup> pixels with more than 500,000 inhabitants.
The original inhabitant raster, however, has a resolution of 1 km<sup>2</sup> which is why we will decrease (aggregate) the resolution by a factor of 20 (see Section <a href="location.html#define-metropolitan-areas">13.5</a>).
Another reason for aggregating a raster is simply to decrease run-time or save disk space.
Of course, this is only possible if the task at hand allows a coarser resolution.
Sometimes a coarser resolution is sufficient for the task at hand.</p>
<div id="geometric-intersections" class="section level3">
<h3><span class="header-section-number">5.3.1</span> Geometric intersections</h3>
<p>
In Section <a href="spatial-operations.html#spatial-raster-subsetting">4.3.1</a> we have shown how to extract values from a raster overlaid by other spatial objects.
To retrieve a spatial output, we can use almost the same subsetting syntax.
The only difference is that we have to make clear that we would like to keep the matrix structure by setting the <code>drop</code>-parameter to <code>FALSE</code>.
This will return a raster object containing the cells whose midpoints overlap with <code>clip</code>.</p>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb176-1"><a href="geometric-operations.html#cb176-1"></a><span class="kw">data</span>(<span class="st">&quot;elev&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;spData&quot;</span>)</span>
<span id="cb176-2"><a href="geometric-operations.html#cb176-2"></a>clip =<span class="st"> </span><span class="kw">raster</span>(<span class="dt">xmn =</span> <span class="fl">0.9</span>, <span class="dt">xmx =</span> <span class="fl">1.8</span>, <span class="dt">ymn =</span> <span class="fl">-0.45</span>, <span class="dt">ymx =</span> <span class="fl">0.45</span>,</span>
<span id="cb176-3"><a href="geometric-operations.html#cb176-3"></a>              <span class="dt">res =</span> <span class="fl">0.3</span>, <span class="dt">vals =</span> <span class="kw">rep</span>(<span class="dv">1</span>, <span class="dv">9</span>))</span>
<span id="cb176-4"><a href="geometric-operations.html#cb176-4"></a>elev[clip, drop =<span class="st"> </span><span class="ot">FALSE</span>]</span>
<span id="cb176-5"><a href="geometric-operations.html#cb176-5"></a><span class="co">#&gt; class      : RasterLayer </span></span>
<span id="cb176-6"><a href="geometric-operations.html#cb176-6"></a><span class="co">#&gt; dimensions : 2, 1, 2  (nrow, ncol, ncell)</span></span>
<span id="cb176-7"><a href="geometric-operations.html#cb176-7"></a><span class="co">#&gt; resolution : 0.5, 0.5  (x, y)</span></span>
<span id="cb176-8"><a href="geometric-operations.html#cb176-8"></a><span class="co">#&gt; extent     : 1, 1.5, -0.5, 0.5  (xmin, xmax, ymin, ymax)</span></span>
<span id="cb176-9"><a href="geometric-operations.html#cb176-9"></a><span class="co">#&gt; crs        : +proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0 </span></span>
<span id="cb176-10"><a href="geometric-operations.html#cb176-10"></a><span class="co">#&gt; source     : memory</span></span>
<span id="cb176-11"><a href="geometric-operations.html#cb176-11"></a><span class="co">#&gt; names      : layer </span></span>
<span id="cb176-12"><a href="geometric-operations.html#cb176-12"></a><span class="co">#&gt; values     : 18, 24  (min, max)</span></span></code></pre></div>
<p>For the same operation we can also use the <code>intersect()</code> and <code>crop()</code> command.</p>
</div>
<div id="extent-and-origin" class="section level3">
<h3><span class="header-section-number">5.3.2</span> Extent and origin</h3>
<p>
When merging or performing map algebra on rasters, their resolution, projection, origin and/or extent have to match. Otherwise, how should we add the values of one raster with a resolution of 0.2 decimal degrees to a second raster with a resolution of 1 decimal degree?
The same problem arises when we would like to merge satellite imagery from different sensors with different projections and resolutions.
We can deal with such mismatches by aligning the rasters.</p>
<p>In the simplest case, two images only differ with regard to their extent.
<!--The `projectRaster()` function reprojects one raster to a desired projection, say from UTM to WGS84.-->
Following code adds one row and two columns to each side of the raster while setting all new values to an elevation of 1000 meters (Figure <a href="geometric-operations.html#fig:extend-example">5.13</a>).</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="geometric-operations.html#cb177-1"></a><span class="kw">data</span>(elev, <span class="dt">package =</span> <span class="st">&quot;spData&quot;</span>)</span>
<span id="cb177-2"><a href="geometric-operations.html#cb177-2"></a>elev_<span class="dv">2</span> =<span class="st"> </span><span class="kw">extend</span>(elev, <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="dt">value =</span> <span class="dv">1000</span>)</span>
<span id="cb177-3"><a href="geometric-operations.html#cb177-3"></a><span class="kw">plot</span>(elev_<span class="dv">2</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:extend-example"></span>
<img src="05-geometry-operations_files/figure-html/extend-example-1.png" alt="Original raster extended by one row on each side (top, bottom) and two columns on each side (right, left)." width="100%" />
<p class="caption">
FIGURE 5.13: Original raster extended by one row on each side (top, bottom) and two columns on each side (right, left).
</p>
</div>
<p>Performing an algebraic operation on two objects with differing extents in R, the <strong>raster</strong> package returns the result for the intersection, and says so in a warning.</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb178-1"><a href="geometric-operations.html#cb178-1"></a>elev_<span class="dv">3</span> =<span class="st"> </span>elev <span class="op">+</span><span class="st"> </span>elev_<span class="dv">2</span></span>
<span id="cb178-2"><a href="geometric-operations.html#cb178-2"></a><span class="co">#&gt; Warning in elev + elev_2: Raster objects have different extents. Result for</span></span>
<span id="cb178-3"><a href="geometric-operations.html#cb178-3"></a><span class="co">#&gt; their intersection is returned</span></span></code></pre></div>
<p>However, we can also align the extent of two rasters with <code>extend()</code>.
Instead of telling the function how many rows or columns should be added (as done before), we allow it to figure it out by using another raster object.
Here, we extend the <code>elev</code> object to the extent of <code>elev_2</code>.
The newly added rows and column receive the default value of the <code>value</code> parameter, i.e., <code>NA</code>.</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="geometric-operations.html#cb179-1"></a>elev_<span class="dv">4</span> =<span class="st"> </span><span class="kw">extend</span>(elev, elev_<span class="dv">2</span>)</span></code></pre></div>
<p>The origin of a raster is the cell corner closest to the coordinates (0, 0).
The <code>origin()</code> function returns the coordinates of the origin.
In the below example a cell corner exists with coordinates (0, 0), but that is not necessarily the case.</p>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="geometric-operations.html#cb180-1"></a><span class="kw">origin</span>(elev_<span class="dv">4</span>)</span>
<span id="cb180-2"><a href="geometric-operations.html#cb180-2"></a><span class="co">#&gt; [1] 0 0</span></span></code></pre></div>
<p>If two rasters have different origins, their cells do not overlap completely which would make map algebra impossible.
To change the origin , use <code>origin()</code>.<a href="#fn21" class="footnote-ref" id="fnref21"><sup>21</sup></a>
Looking at Figure <a href="geometric-operations.html#fig:origin-example">5.14</a> reveals the effect of changing the origin.</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="geometric-operations.html#cb181-1"></a><span class="co"># change the origin</span></span>
<span id="cb181-2"><a href="geometric-operations.html#cb181-2"></a><span class="kw">origin</span>(elev_<span class="dv">4</span>) =<span class="st"> </span><span class="kw">c</span>(<span class="fl">0.25</span>, <span class="fl">0.25</span>)</span>
<span id="cb181-3"><a href="geometric-operations.html#cb181-3"></a><span class="kw">plot</span>(elev_<span class="dv">4</span>)</span>
<span id="cb181-4"><a href="geometric-operations.html#cb181-4"></a><span class="co"># and add the original raster</span></span>
<span id="cb181-5"><a href="geometric-operations.html#cb181-5"></a><span class="kw">plot</span>(elev, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:origin-example"></span>
<img src="05-geometry-operations_files/figure-html/origin-example-1.png" alt="Rasters with identical values but different origins." width="100%" />
<p class="caption">
FIGURE 5.14: Rasters with identical values but different origins.
</p>
</div>
<p>Note that changing the resolution frequently (next section) also changes the origin.</p>
</div>
<div id="aggregation-and-disaggregation" class="section level3">
<h3><span class="header-section-number">5.3.3</span> Aggregation and disaggregation</h3>
<p>


Raster datasets can also differ with regard to their resolution.
To match resolutions, one can either decrease (<code>aggregate()</code>) or increase (<code>disaggregate()</code>) the resolution of one raster.<a href="#fn22" class="footnote-ref" id="fnref22"><sup>22</sup></a>
As an example, we here change the spatial resolution of <code>dem</code> (found in the <strong>RQGIS</strong> package) by a factor of 5 (Figure <a href="geometric-operations.html#fig:aggregate-example">5.15</a>).
Additionally, the output cell value should correspond to the mean of the input cells (note that one could use other functions as well, such as <code>median()</code>, <code>sum()</code>, etc.):</p>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb182-1"><a href="geometric-operations.html#cb182-1"></a><span class="kw">data</span>(<span class="st">&quot;dem&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;spDataLarge&quot;</span>)</span>
<span id="cb182-2"><a href="geometric-operations.html#cb182-2"></a>dem_agg =<span class="st"> </span><span class="kw">aggregate</span>(dem, <span class="dt">fact =</span> <span class="dv">5</span>, <span class="dt">fun =</span> mean)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:aggregate-example"></span>
<img src="05-geometry-operations_files/figure-html/aggregate-example-1.png" alt="Original raster (left). Aggregated raster (right)." width="100%" />
<p class="caption">
FIGURE 5.15: Original raster (left). Aggregated raster (right).
</p>
</div>
<p>By contrast, the<code>disaggregate()</code> function increases the resolution.
However, we have to specify a method on how to fill the new cells.
The <code>disaggregate()</code> function provides two methods.
The first (<code>method = ""</code>) simply gives all output cells the value of the input cell, and hence duplicates values which leads to a blocky output image.</p>
<p>The <code>bilinear</code> method, in turn, is an interpolation technique that uses the four nearest pixel centers of the input image (salmon colored points in Figure <a href="geometric-operations.html#fig:bilinear">5.16</a>) to compute an average weighted by distance (arrows in Figure <a href="geometric-operations.html#fig:bilinear">5.16</a> as the value of the output cell - square in the upper left corner in Figure <a href="geometric-operations.html#fig:bilinear">5.16</a>).</p>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="geometric-operations.html#cb183-1"></a>dem_disagg =<span class="st"> </span><span class="kw">disaggregate</span>(dem_agg, <span class="dt">fact =</span> <span class="dv">5</span>, <span class="dt">method =</span> <span class="st">&quot;bilinear&quot;</span>)</span>
<span id="cb183-2"><a href="geometric-operations.html#cb183-2"></a><span class="kw">identical</span>(dem, dem_disagg)</span>
<span id="cb183-3"><a href="geometric-operations.html#cb183-3"></a><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:bilinear"></span>
<img src="05-geometry-operations_files/figure-html/bilinear-1.png" alt="Bilinear disaggregation in action." width="100%" />
<p class="caption">
FIGURE 5.16: Bilinear disaggregation in action.
</p>
</div>
<p>Comparing the values of <code>dem</code> and <code>dem_disagg</code> tells us that they are not identical (you can also use <code>compareRaster()</code> or <code>all.equal()</code>).
However, this was hardly to be expected, since disaggregating is a simple interpolation technique.
It is important to keep in mind that disaggregating results in a finer resolution; the corresponding values, however, are only as accurate as their lower resolution source.</p>
<p>The process of computing values for new pixel locations is also called resampling.
In fact, the <strong>raster</strong> package provides a <code>resample()</code> function.
It lets you align several raster properties in one go, namely origin, extent and resolution.
By default, it uses the <code>bilinear</code>-interpolation.</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="geometric-operations.html#cb184-1"></a><span class="co"># add 2 rows and columns, i.e. change the extent</span></span>
<span id="cb184-2"><a href="geometric-operations.html#cb184-2"></a>dem_agg =<span class="st"> </span><span class="kw">extend</span>(dem_agg, <span class="dv">2</span>)</span>
<span id="cb184-3"><a href="geometric-operations.html#cb184-3"></a>dem_disagg_<span class="dv">2</span> =<span class="st"> </span><span class="kw">resample</span>(dem_agg, dem)</span></code></pre></div>
<p>Finally, in order to align many (possibly hundreds or thousands of) images stored on disk, you could use the <code>gdalUtils::align_rasters()</code> function.
However, you may also use <strong>raster</strong> with very large datasets.
This is because <strong>raster</strong>:</p>
<ol style="list-style-type: decimal">
<li>Lets you work with raster datasets that are too large to fit into the main memory (RAM) by only processing chunks of it.</li>
<li>Tries to facilitate parallel processing.
For more information, see the help pages of <code>beginCluster()</code> and <code>clusteR()</code>.
Additionally, check out the <em>Multi-core functions</em> section in <code>vignette("functions", package = "raster")</code>.</li>
</ol>
</div>
</div>
<div id="raster-vector" class="section level2">
<h2><span class="header-section-number">5.4</span> Raster-vector interactions</h2>
<p>
This section focuses on interactions between raster and vector geographic data models, introduced in Chapter <a href="spatial-class.html#spatial-class">2</a>.
It includes four main techniques:
raster cropping and masking using vector objects (Section <a href="geometric-operations.html#raster-cropping">5.4.1</a>);
extracting raster values using different types of vector data (Section <a href="geometric-operations.html#raster-extraction">5.4.2</a>);
and raster-vector conversion (Sections <a href="geometric-operations.html#rasterization">5.4.3</a> and <a href="geometric-operations.html#spatial-vectorization">5.4.4</a>).
<!-- operations are not symmetrical, for example: -->
<!-- - raster clipping - no vector counterpart -->
<!-- - raster extraction is connected to some methods used in vectorization and rasterization -->
<!-- - etc. -->
The above concepts are demonstrated using data used in previous chapters to understand their potential real-world applications.</p>
<div id="raster-cropping" class="section level3">
<h3><span class="header-section-number">5.4.1</span> Raster cropping</h3>
<p>
Many geographic data projects involve integrating data from many different sources, such as remote sensing images (rasters) and administrative boundaries (vectors).
Often the extent of input raster datasets is larger than the area of interest.
In this case raster <strong>cropping</strong> and <strong>masking</strong> are useful for unifying the spatial extent of input data.
Both operations reduce object memory use and associated computational resources for subsequent analysis steps, and may be a necessary preprocessing step before creating attractive maps involving raster data.</p>
<p>We will use two objects to illustrate raster cropping:</p>
<ul>
<li>A <code>raster</code> object <code>srtm</code> representing elevation (meters above sea level) in south-western Utah.</li>
<li>A vector (<code>sf</code>) object <code>zion</code> representing Zion National Park.</li>
</ul>
<p>Both target and cropping objects must have the same projection.
The following code chunk therefore not only loads the datasets, from the <strong>spDataLarge</strong> package installed in Chapter <a href="spatial-class.html#spatial-class">2</a>,
it also reprojects <code>zion</code> (see Section <a href="reproj-geo-data.html#reproj-geo-data">6</a> for more on reprojection):</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb185-1"><a href="geometric-operations.html#cb185-1"></a>srtm =<span class="st"> </span><span class="kw">raster</span>(<span class="kw">system.file</span>(<span class="st">&quot;raster/srtm.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;spDataLarge&quot;</span>))</span>
<span id="cb185-2"><a href="geometric-operations.html#cb185-2"></a>zion =<span class="st"> </span><span class="kw">st_read</span>(<span class="kw">system.file</span>(<span class="st">&quot;vector/zion.gpkg&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;spDataLarge&quot;</span>))</span>
<span id="cb185-3"><a href="geometric-operations.html#cb185-3"></a>zion =<span class="st"> </span><span class="kw">st_transform</span>(zion, <span class="kw">projection</span>(srtm))</span></code></pre></div>
<p>We will use <code>crop()</code> from the <strong>raster</strong> package to crop the <code>srtm</code> raster.
<code>crop()</code> reduces the rectangular extent of the object passed to its first argument based on the extent of the object passed to its second argument, as demonstrated in the command below (which generates Figure <a href="geometric-operations.html#fig:cropmask">5.17</a>(B) — note the smaller extent of the raster background):</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="geometric-operations.html#cb186-1"></a>srtm_cropped =<span class="st"> </span><span class="kw">crop</span>(srtm, zion)</span></code></pre></div>
<p>
Related to <code>crop()</code> is the <strong>raster</strong> function <code>mask()</code>, which sets values outside of the bounds of the object passed to its second argument to <code>NA</code>.
The following command therefore masks every cell outside of the Zion National Park boundaries (Figure <a href="geometric-operations.html#fig:cropmask">5.17</a>(C)):</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb187-1"><a href="geometric-operations.html#cb187-1"></a>srtm_masked =<span class="st"> </span><span class="kw">mask</span>(srtm, zion)</span></code></pre></div>
<p>Changing the settings of <code>mask()</code> yields different results.
Setting <code>updatevalue = 0</code>, for example, will set all pixels outside the national park to 0.
Setting <code>inverse = TRUE</code> will mask everything <em>inside</em> the bounds of the park (see <code>?mask</code> for details) (Figure <a href="geometric-operations.html#fig:cropmask">5.17</a>(D)).</p>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb188-1"><a href="geometric-operations.html#cb188-1"></a>srtm_inv_masked =<span class="st"> </span><span class="kw">mask</span>(srtm, zion, <span class="dt">inverse =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:cropmask"></span>
<img src="05-geometry-operations_files/figure-html/cropmask-1.png" alt="Illustration of raster cropping and raster masking." width="100%" />
<p class="caption">
FIGURE 5.17: Illustration of raster cropping and raster masking.
</p>
</div>
</div>
<div id="raster-extraction" class="section level3">
<h3><span class="header-section-number">5.4.2</span> Raster extraction</h3>
<p>
Raster extraction is the process of identifying and returning the values associated with a ‘target’ raster at specific locations, based on a (typically vector) geographic ‘selector’ object.
The results depend on the type of selector used (points, lines or polygons) and arguments passed to the <code>raster::extract()</code> function, which we use to demonstrate raster extraction.
The reverse of raster extraction — assigning raster cell values based on vector objects — is rasterization, described in Section <a href="geometric-operations.html#rasterization">5.4.3</a>.</p>
<p>The simplest example is extracting the value of a raster cell at specific <strong>points</strong>.
For this purpose, we will use <code>zion_points</code>, which contain a sample of 30 locations within the Zion National Park (Figure <a href="geometric-operations.html#fig:pointextr">5.18</a>).
<!-- They could represent places where soils properties were measured and we want to know what is the elevation of each point. -->
The following command extracts elevation values from <code>srtm</code> and assigns the resulting vector to a new column (<code>elevation</code>) in the <code>zion_points</code> dataset:</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="geometric-operations.html#cb189-1"></a><span class="kw">data</span>(<span class="st">&quot;zion_points&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;spDataLarge&quot;</span>)</span>
<span id="cb189-2"><a href="geometric-operations.html#cb189-2"></a>zion_points<span class="op">$</span>elevation =<span class="st"> </span>raster<span class="op">::</span><span class="kw">extract</span>(srtm, zion_points)</span></code></pre></div>
<p>The <code>buffer</code> argument can be used to specify a buffer radius (in meters) around each point.
The result of <code>raster::extract(srtm, zion_points, buffer = 1000)</code>, for example, is a list of vectors, each of which representing the values of cells inside the buffer associated with each point.
In practice, this example is a special case of extraction with a polygon selector, described below.</p>
<div class="figure" style="text-align: center"><span id="fig:pointextr"></span>
<img src="05-geometry-operations_files/figure-html/pointextr-1.png" alt="Locations of points used for raster extraction." width="60%" />
<p class="caption">
FIGURE 5.18: Locations of points used for raster extraction.
</p>
</div>
<p>Raster extraction also works with <strong>line</strong> selectors.
To demonstrate this, the code below creates <code>zion_transect</code>, a straight line going from northwest to southeast of the Zion National Park, illustrated in Figure <a href="geometric-operations.html#fig:lineextr">5.19</a>(A) (see Section <a href="spatial-class.html#vector-data">2.2</a> for a recap on the vector data model):</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb190-1"><a href="geometric-operations.html#cb190-1"></a>zion_transect =<span class="st"> </span><span class="kw">cbind</span>(<span class="kw">c</span>(<span class="op">-</span><span class="fl">113.2</span>, <span class="fl">-112.9</span>), <span class="kw">c</span>(<span class="fl">37.45</span>, <span class="fl">37.2</span>)) <span class="op">%&gt;%</span></span>
<span id="cb190-2"><a href="geometric-operations.html#cb190-2"></a><span class="st">  </span><span class="kw">st_linestring</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb190-3"><a href="geometric-operations.html#cb190-3"></a><span class="st">  </span><span class="kw">st_sfc</span>(<span class="dt">crs =</span> <span class="kw">projection</span>(srtm)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb190-4"><a href="geometric-operations.html#cb190-4"></a><span class="st">  </span><span class="kw">st_sf</span>()</span></code></pre></div>
<p>The utility of extracting heights from a linear selector is illustrated by imagining that you are planning a hike.
The method demonstrated below provides an ‘elevation profile’ of the route (the line does not need to be straight), useful for estimating how long it will take due to long climbs:</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb191-1"><a href="geometric-operations.html#cb191-1"></a>transect =<span class="st"> </span>raster<span class="op">::</span><span class="kw">extract</span>(srtm, zion_transect, </span>
<span id="cb191-2"><a href="geometric-operations.html#cb191-2"></a>                           <span class="dt">along =</span> <span class="ot">TRUE</span>, <span class="dt">cellnumbers =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p>Note the use of <code>along = TRUE</code> and <code>cellnumbers = TRUE</code> arguments to return cell IDs <em>along</em> the path.
The result is a list containing a matrix of cell IDs in the first column and elevation values in the second.
The number of list elements is equal to the number of lines or polygons from which we are extracting values.
The subsequent code chunk first converts this tricky matrix-in-a-list object into a simple data frame, returns the coordinates associated with each extracted cell, and finds the associated distances along the transect (see <code>?geosphere::distGeo()</code> for details):</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb192-1"><a href="geometric-operations.html#cb192-1"></a>transect_df =<span class="st"> </span>purrr<span class="op">::</span><span class="kw">map_dfr</span>(transect, as_data_frame, <span class="dt">.id =</span> <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb192-2"><a href="geometric-operations.html#cb192-2"></a><span class="co">#&gt; Warning: `as_data_frame()` is deprecated as of tibble 2.0.0.</span></span>
<span id="cb192-3"><a href="geometric-operations.html#cb192-3"></a><span class="co">#&gt; Please use `as_tibble()` instead.</span></span>
<span id="cb192-4"><a href="geometric-operations.html#cb192-4"></a><span class="co">#&gt; The signature and semantics have changed, see `?as_tibble`.</span></span>
<span id="cb192-5"><a href="geometric-operations.html#cb192-5"></a><span class="co">#&gt; This warning is displayed once every 8 hours.</span></span>
<span id="cb192-6"><a href="geometric-operations.html#cb192-6"></a><span class="co">#&gt; Call `lifecycle::last_warnings()` to see where this warning was generated.</span></span>
<span id="cb192-7"><a href="geometric-operations.html#cb192-7"></a>transect_coords =<span class="st"> </span><span class="kw">xyFromCell</span>(srtm, transect_df<span class="op">$</span>cell)</span>
<span id="cb192-8"><a href="geometric-operations.html#cb192-8"></a>pair_dist =<span class="st"> </span>geosphere<span class="op">::</span><span class="kw">distGeo</span>(transect_coords)[<span class="op">-</span><span class="kw">nrow</span>(transect_coords)]</span>
<span id="cb192-9"><a href="geometric-operations.html#cb192-9"></a>transect_df<span class="op">$</span>dist =<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">cumsum</span>(pair_dist)) </span></code></pre></div>
<p>The resulting <code>transect_df</code> can be used to create elevation profiles, as illustrated in Figure <a href="geometric-operations.html#fig:lineextr">5.19</a>(B).</p>
<div class="figure" style="text-align: center"><span id="fig:lineextr"></span>
<img src="05-geometry-operations_files/figure-html/lineextr-1.png" alt="Location of a line used for raster extraction (left) and the elevation along this line (right)." width="100%" />
<p class="caption">
FIGURE 5.19: Location of a line used for raster extraction (left) and the elevation along this line (right).
</p>
</div>
<p>The final type of geographic vector object for raster extraction is <strong>polygons</strong>.
Like lines and buffers, polygons tend to return many raster values per polygon.
This is demonstrated in the command below, which results in a data frame with column names <code>ID</code> (the row number of the polygon) and <code>srtm</code> (associated elevation values):</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="geometric-operations.html#cb193-1"></a>zion_srtm_values =<span class="st"> </span>raster<span class="op">::</span><span class="kw">extract</span>(<span class="dt">x =</span> srtm, <span class="dt">y =</span> zion, <span class="dt">df =</span> <span class="ot">TRUE</span>) </span></code></pre></div>
<p>Such results can be used to generate summary statistics for raster values per polygon, for example to characterize a single region or to compare many regions.
The generation of summary statistics is demonstrated in the code below, which creates the object <code>zion_srtm_df</code> containing summary statistics for elevation values in Zion National Park (see Figure <a href="geometric-operations.html#fig:polyextr">5.20</a>(A)):</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb194-1"><a href="geometric-operations.html#cb194-1"></a><span class="kw">group_by</span>(zion_srtm_values, ID) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb194-2"><a href="geometric-operations.html#cb194-2"></a><span class="st">  </span><span class="kw">summarize_at</span>(<span class="kw">vars</span>(srtm), <span class="kw">list</span>(<span class="op">~</span><span class="kw">min</span>(.), <span class="op">~</span><span class="kw">mean</span>(.), <span class="op">~</span><span class="kw">max</span>(.)))</span>
<span id="cb194-3"><a href="geometric-operations.html#cb194-3"></a><span class="co">#&gt; # A tibble: 1 x 4</span></span>
<span id="cb194-4"><a href="geometric-operations.html#cb194-4"></a><span class="co">#&gt;      ID   min  mean   max</span></span>
<span id="cb194-5"><a href="geometric-operations.html#cb194-5"></a><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb194-6"><a href="geometric-operations.html#cb194-6"></a><span class="co">#&gt; 1     1  1122 1818.  2661</span></span></code></pre></div>
<p>The preceding code chunk used the <strong>tidyverse</strong> to provide summary statistics for cell values per polygon ID, as described in Chapter <a href="attr.html#attr">3</a>.
The results provide useful summaries, for example that the maximum height in the park is around 2,661 meters (other summary statistics, such as standard deviation, can also be calculated in this way).
Because there is only one polygon in the example a data frame with a single row is returned; however, the method works when multiple selector polygons are used.</p>
<p>The same approach works for counting occurrences of categorical raster values within polygons.
This is illustrated with a land cover dataset (<code>nlcd</code>) from the <strong>spDataLarge</strong> package in Figure <a href="geometric-operations.html#fig:polyextr">5.20</a>(B), and demonstrated in the code below:</p>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb195-1"><a href="geometric-operations.html#cb195-1"></a>zion_nlcd =<span class="st"> </span>raster<span class="op">::</span><span class="kw">extract</span>(nlcd, zion, <span class="dt">df =</span> <span class="ot">TRUE</span>, <span class="dt">factors =</span> <span class="ot">TRUE</span>) </span>
<span id="cb195-2"><a href="geometric-operations.html#cb195-2"></a>dplyr<span class="op">::</span><span class="kw">select</span>(zion_nlcd, ID, levels) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb195-3"><a href="geometric-operations.html#cb195-3"></a><span class="st">  </span>tidyr<span class="op">::</span><span class="kw">gather</span>(key, value, <span class="op">-</span>ID) <span class="op">%&gt;%</span></span>
<span id="cb195-4"><a href="geometric-operations.html#cb195-4"></a><span class="st">  </span><span class="kw">group_by</span>(ID, key, value) <span class="op">%&gt;%</span></span>
<span id="cb195-5"><a href="geometric-operations.html#cb195-5"></a><span class="st">  </span><span class="kw">tally</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb195-6"><a href="geometric-operations.html#cb195-6"></a><span class="st">  </span>tidyr<span class="op">::</span><span class="kw">spread</span>(value, n, <span class="dt">fill =</span> <span class="dv">0</span>)</span>
<span id="cb195-7"><a href="geometric-operations.html#cb195-7"></a><span class="co">#&gt; # A tibble: 1 x 9</span></span>
<span id="cb195-8"><a href="geometric-operations.html#cb195-8"></a><span class="co">#&gt; # Groups:   ID, key [1]</span></span>
<span id="cb195-9"><a href="geometric-operations.html#cb195-9"></a><span class="co">#&gt;      ID key    Barren Cultivated Developed Forest Herbaceous Shrubland Wetlands</span></span>
<span id="cb195-10"><a href="geometric-operations.html#cb195-10"></a><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span id="cb195-11"><a href="geometric-operations.html#cb195-11"></a><span class="co">#&gt; 1     1 levels  98285         62      4205 298299        235    203701      679</span></span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:polyextr"></span>
<img src="05-geometry-operations_files/figure-html/polyextr-1.png" alt="Area used for continuous (left) and categorical (right) raster extraction." width="100%" />
<p class="caption">
FIGURE 5.20: Area used for continuous (left) and categorical (right) raster extraction.
</p>
</div>
<p>So far, we have seen how <code>raster::extract()</code> is a flexible way of extracting raster cell values from a range of input geographic objects.
An issue with the function, however, is that it is relatively slow.
If this is a problem, it is useful to know about alternatives and work-arounds, three of which are presented below.</p>
<ul>
<li><strong>Parallelization</strong>: this approach works when using many geographic vector selector objects by splitting them into groups and extracting cell values independently for each group (see <code>?raster::clusterR()</code> for details of this approach)
<!-- tabularaster (ref to the vignette - https://cran.r-project.org/web/packages/tabularaster/vignettes/tabularaster-usage.html)--></li>
<li>Use the <strong>velox</strong> package <span class="citation">(Hunziker <a href="#ref-hunziker_velox:_2017" role="doc-biblioref">2017</a>)</span>, which provides a fast method for extracting raster data that fits in memory (see the package’s <a href="https://hunzikp.github.io/velox/extract.html"><code>extract</code></a> vignette for details)</li>
<li>Using <strong>R-GIS bridges</strong> (see Chapter <a href="gis.html#gis">9</a>): efficient calculation of raster statistics from polygons can be found in the SAGA function <code>saga:gridstatisticsforpolygons</code>, for example, which can be accessed via <strong>RQGIS</strong>
<!-- Methods similar to `raster::extract` can be found in GRASS GIS (e.g. v.rast.stats) -->
<!-- https://grass.osgeo.org/grass74/manuals/v.rast.stats.html - test -->
<!-- https://twitter.com/mdsumner/status/976978499402571776 -->
<!-- https://gist.github.com/mdsumner/d0b26238321a5d2c2c2ba663ff684183 --></li>
</ul>
</div>
<div id="rasterization" class="section level3">
<h3><span class="header-section-number">5.4.3</span> Rasterization</h3>
<p>
Rasterization is the conversion of vector objects into their representation in raster objects.
Usually, the output raster is used for quantitative analysis (e.g., analysis of terrain) or modeling.
As we saw in Chapter <a href="spatial-class.html#spatial-class">2</a> the raster data model has some characteristics that make it conducive to certain methods.
Furthermore, the process of rasterization can help simplify datasets because the resulting values all have the same spatial resolution: rasterization can be seen as a special type of geographic data aggregation.</p>
<p>The <strong>raster</strong> package contains the function <code>rasterize()</code> for doing this work.
Its first two arguments are, <code>x</code>, vector object to be rasterized and, <code>y</code>, a ‘template raster’ object defining the extent, resolution and CRS of the output.
The geographic resolution of the input raster has a major impact on the results: if it is too low (cell size is too large), the result may miss the full geographic variability of the vector data; if it is too high, computational times may be excessive.
There are no simple rules to follow when deciding an appropriate geographic resolution, which is heavily dependent on the intended use of the results.
Often the target resolution is imposed on the user, for example when the output of rasterization needs to be aligned to the existing raster.</p>
<p>To demonstrate rasterization in action, we will use a template raster that has the same extent and CRS as the input vector data <code>cycle_hire_osm_projected</code> (a dataset on cycle hire points in London is illustrated in Figure <a href="geometric-operations.html#fig:vector-rasterization1">5.21</a>(A)) and spatial resolution of 1000 meters:</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="geometric-operations.html#cb196-1"></a>cycle_hire_osm_projected =<span class="st"> </span><span class="kw">st_transform</span>(cycle_hire_osm, <span class="dv">27700</span>)</span>
<span id="cb196-2"><a href="geometric-operations.html#cb196-2"></a>raster_template =<span class="st"> </span><span class="kw">raster</span>(<span class="kw">extent</span>(cycle_hire_osm_projected), <span class="dt">resolution =</span> <span class="dv">1000</span>,</span>
<span id="cb196-3"><a href="geometric-operations.html#cb196-3"></a>                         <span class="dt">crs =</span> <span class="kw">st_crs</span>(cycle_hire_osm_projected)<span class="op">$</span>proj4string)</span>
<span id="cb196-4"><a href="geometric-operations.html#cb196-4"></a><span class="co">#&gt; Warning in showSRID(uprojargs, format = &quot;PROJ&quot;, multiline = &quot;NO&quot;, prefer_proj</span></span>
<span id="cb196-5"><a href="geometric-operations.html#cb196-5"></a><span class="co">#&gt; = prefer_proj): Discarded datum Unknown based on Airy 1830 ellipsoid in CRS</span></span>
<span id="cb196-6"><a href="geometric-operations.html#cb196-6"></a><span class="co">#&gt; definition</span></span></code></pre></div>
<p>Rasterization is a very flexible operation: the results depend not only on the nature of the template raster, but also on the type of input vector (e.g., points, polygons) and a variety of arguments taken by the <code>rasterize()</code> function.</p>
<p>To illustrate this flexibility we will try three different approaches to rasterization.
First, we create a raster representing the presence or absence of cycle hire points (known as presence/absence rasters).
In this case <code>rasterize()</code> requires only one argument in addition to <code>x</code> and <code>y</code> (the aforementioned vector and raster objects): a value to be transferred to all non-empty cells specified by <code>field</code> (results illustrated Figure <a href="geometric-operations.html#fig:vector-rasterization1">5.21</a>(B)).</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="geometric-operations.html#cb197-1"></a>ch_raster1 =<span class="st"> </span><span class="kw">rasterize</span>(cycle_hire_osm_projected, raster_template, <span class="dt">field =</span> <span class="dv">1</span>)</span>
<span id="cb197-2"><a href="geometric-operations.html#cb197-2"></a><span class="co">#&gt; Warning in showSRID(uprojargs, format = &quot;PROJ&quot;, multiline = &quot;NO&quot;, prefer_proj</span></span>
<span id="cb197-3"><a href="geometric-operations.html#cb197-3"></a><span class="co">#&gt; = prefer_proj): Discarded datum Unknown based on Airy 1830 ellipsoid in CRS</span></span>
<span id="cb197-4"><a href="geometric-operations.html#cb197-4"></a><span class="co">#&gt; definition</span></span>
<span id="cb197-5"><a href="geometric-operations.html#cb197-5"></a><span class="co">#&gt; Warning in showSRID(SRS_string, format = &quot;PROJ&quot;, multiline = &quot;NO&quot;, prefer_proj =</span></span>
<span id="cb197-6"><a href="geometric-operations.html#cb197-6"></a><span class="co">#&gt; prefer_proj): Discarded datum OSGB 1936 in CRS definition</span></span></code></pre></div>
<p>The <code>fun</code> argument specifies summary statistics used to convert multiple observations in close proximity into associate cells in the raster object.
By default <code>fun = "last"</code> is used but other options such as <code>fun = "count"</code> can be used, in this case to count the number of cycle hire points in each grid cell (the results of this operation are illustrated in Figure <a href="geometric-operations.html#fig:vector-rasterization1">5.21</a>(C)).</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="geometric-operations.html#cb198-1"></a>ch_raster2 =<span class="st"> </span><span class="kw">rasterize</span>(cycle_hire_osm_projected, raster_template, </span>
<span id="cb198-2"><a href="geometric-operations.html#cb198-2"></a>                       <span class="dt">field =</span> <span class="dv">1</span>, <span class="dt">fun =</span> <span class="st">&quot;count&quot;</span>)</span>
<span id="cb198-3"><a href="geometric-operations.html#cb198-3"></a><span class="co">#&gt; Warning in showSRID(uprojargs, format = &quot;PROJ&quot;, multiline = &quot;NO&quot;, prefer_proj</span></span>
<span id="cb198-4"><a href="geometric-operations.html#cb198-4"></a><span class="co">#&gt; = prefer_proj): Discarded datum Unknown based on Airy 1830 ellipsoid in CRS</span></span>
<span id="cb198-5"><a href="geometric-operations.html#cb198-5"></a><span class="co">#&gt; definition</span></span>
<span id="cb198-6"><a href="geometric-operations.html#cb198-6"></a><span class="co">#&gt; Warning in showSRID(SRS_string, format = &quot;PROJ&quot;, multiline = &quot;NO&quot;, prefer_proj =</span></span>
<span id="cb198-7"><a href="geometric-operations.html#cb198-7"></a><span class="co">#&gt; prefer_proj): Discarded datum OSGB 1936 in CRS definition</span></span></code></pre></div>
<p>The new output, <code>ch_raster2</code>, shows the number of cycle hire points in each grid cell.
The cycle hire locations have different numbers of bicycles described by the <code>capacity</code> variable, raising the question, what’s the capacity in each grid cell?
To calculate that we must <code>sum</code> the field (<code>"capacity"</code>), resulting in output illustrated in Figure <a href="geometric-operations.html#fig:vector-rasterization1">5.21</a>(D), calculated with the following command (other summary functions such as <code>mean</code> could be used):</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="geometric-operations.html#cb199-1"></a>ch_raster3 =<span class="st"> </span><span class="kw">rasterize</span>(cycle_hire_osm_projected, raster_template, </span>
<span id="cb199-2"><a href="geometric-operations.html#cb199-2"></a>                       <span class="dt">field =</span> <span class="st">&quot;capacity&quot;</span>, <span class="dt">fun =</span> sum)</span>
<span id="cb199-3"><a href="geometric-operations.html#cb199-3"></a><span class="co">#&gt; Warning in showSRID(uprojargs, format = &quot;PROJ&quot;, multiline = &quot;NO&quot;, prefer_proj</span></span>
<span id="cb199-4"><a href="geometric-operations.html#cb199-4"></a><span class="co">#&gt; = prefer_proj): Discarded datum Unknown based on Airy 1830 ellipsoid in CRS</span></span>
<span id="cb199-5"><a href="geometric-operations.html#cb199-5"></a><span class="co">#&gt; definition</span></span>
<span id="cb199-6"><a href="geometric-operations.html#cb199-6"></a><span class="co">#&gt; Warning in showSRID(SRS_string, format = &quot;PROJ&quot;, multiline = &quot;NO&quot;, prefer_proj =</span></span>
<span id="cb199-7"><a href="geometric-operations.html#cb199-7"></a><span class="co">#&gt; prefer_proj): Discarded datum OSGB 1936 in CRS definition</span></span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:vector-rasterization1"></span>
<img src="05-geometry-operations_files/figure-html/vector-rasterization1-1.png" alt="Examples of point rasterization." width="100%" />
<p class="caption">
FIGURE 5.21: Examples of point rasterization.
</p>
</div>
<p>Another dataset based on California’s polygons and borders (created below) illustrates rasterization of lines.
After casting the polygon objects into a multilinestring, a template raster is created with a resolution of a 0.5 degree:</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="geometric-operations.html#cb200-1"></a>california =<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">filter</span>(us_states, NAME <span class="op">==</span><span class="st"> &quot;California&quot;</span>)</span>
<span id="cb200-2"><a href="geometric-operations.html#cb200-2"></a>california_borders =<span class="st"> </span><span class="kw">st_cast</span>(california, <span class="st">&quot;MULTILINESTRING&quot;</span>)</span>
<span id="cb200-3"><a href="geometric-operations.html#cb200-3"></a>raster_template2 =<span class="st"> </span><span class="kw">raster</span>(<span class="kw">extent</span>(california), <span class="dt">resolution =</span> <span class="fl">0.5</span>,</span>
<span id="cb200-4"><a href="geometric-operations.html#cb200-4"></a>                         <span class="dt">crs =</span> <span class="kw">st_crs</span>(california)<span class="op">$</span>proj4string)</span>
<span id="cb200-5"><a href="geometric-operations.html#cb200-5"></a><span class="co">#&gt; Warning in showSRID(uprojargs, format = &quot;PROJ&quot;, multiline = &quot;NO&quot;, prefer_proj =</span></span>
<span id="cb200-6"><a href="geometric-operations.html#cb200-6"></a><span class="co">#&gt; prefer_proj): Discarded datum Unknown based on GRS80 ellipsoid in CRS definition</span></span></code></pre></div>
<p>Line rasterization is demonstrated in the code below.
In the resulting raster, all cells that are touched by a line get a value, as illustrated in Figure <a href="geometric-operations.html#fig:vector-rasterization2">5.22</a>(A).</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="geometric-operations.html#cb201-1"></a>california_raster1 =<span class="st"> </span><span class="kw">rasterize</span>(california_borders, raster_template2) </span>
<span id="cb201-2"><a href="geometric-operations.html#cb201-2"></a><span class="co">#&gt; Warning in showSRID(uprojargs, format = &quot;PROJ&quot;, multiline = &quot;NO&quot;, prefer_proj =</span></span>
<span id="cb201-3"><a href="geometric-operations.html#cb201-3"></a><span class="co">#&gt; prefer_proj): Discarded datum Unknown based on GRS80 ellipsoid in CRS definition</span></span></code></pre></div>
<p>Polygon rasterization, by contrast, selects only cells whose centroids are inside the selector polygon, as illustrated in Figure <a href="geometric-operations.html#fig:vector-rasterization2">5.22</a>(B).</p>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="geometric-operations.html#cb202-1"></a>california_raster2 =<span class="st"> </span><span class="kw">rasterize</span>(california, raster_template2) </span>
<span id="cb202-2"><a href="geometric-operations.html#cb202-2"></a><span class="co">#&gt; Warning in showSRID(uprojargs, format = &quot;PROJ&quot;, multiline = &quot;NO&quot;, prefer_proj =</span></span>
<span id="cb202-3"><a href="geometric-operations.html#cb202-3"></a><span class="co">#&gt; prefer_proj): Discarded datum Unknown based on GRS80 ellipsoid in CRS definition</span></span></code></pre></div>
<!-- getCover? -->
<!-- the fraction of each grid cell that is covered by the polygons-->
<!-- ```{r, echo=FALSE, eval=FALSE} -->
<!-- california_raster3 = rasterize(california, raster_template2, getCover = TRUE) -->
<!-- r3po = tm_shape(california_raster3) + -->
<!--   tm_raster(legend.show = TRUE, title = "Values: ", style = "fixed", breaks = c(0, 1, 25, 50, 75, 100)) + -->
<!--   tm_shape(california) + -->
<!--   tm_borders() + -->
<!--   tm_layout(outer.margins = rep(0.01, 4), -->
<!--             inner.margins = rep(0, 4)) -->
<!-- ``` -->
<!-- It is also possible to use the `field` or `fun` arguments for lines and polygons rasterizations. -->
<div class="figure" style="text-align: center"><span id="fig:vector-rasterization2"></span>
<img src="05-geometry-operations_files/figure-html/vector-rasterization2-1.png" alt="Examples of line and polygon rasterizations." width="100%" />
<p class="caption">
FIGURE 5.22: Examples of line and polygon rasterizations.
</p>
</div>
<p>As with <code>raster::extract()</code>, <code>raster::rasterize()</code> works well for most cases but is not performance optimized.
Fortunately, there are several alternatives, including the <code>fasterize::fasterize()</code> and <code>gdalUtils::gdal_rasterize()</code>.
The former is much (100 times+) faster than <code>rasterize()</code>, but is currently limited to polygon rasterization.
The latter is part of GDAL and therefore requires a vector file (instead of an <code>sf</code> object) and rasterization parameters (instead of a <code>Raster*</code> template object) as inputs.<a href="#fn23" class="footnote-ref" id="fnref23"><sup>23</sup></a></p>
</div>
<div id="spatial-vectorization" class="section level3">
<h3><span class="header-section-number">5.4.4</span> Spatial vectorization</h3>
<p>
Spatial vectorization is the counterpart of rasterization (Section <a href="geometric-operations.html#rasterization">5.4.3</a>), but in the opposite direction.
It involves converting spatially continuous raster data into spatially discrete vector data such as points, lines or polygons.</p>

<div class="rmdnote">
Be careful with the wording!
In R, vectorization refers to the possibility of replacing <code>for</code>-loops and alike by doing things like <code>1:10 / 2</code> (see also <span class="citation">Wickham (<a href="#ref-wickham_advanced_2014" role="doc-biblioref">2014</a><a href="#ref-wickham_advanced_2014" role="doc-biblioref">a</a>)</span>).
</div>

<p>The simplest form of vectorization is to convert the centroids of raster cells into points.
<code>rasterToPoints()</code> does exactly this for all non-<code>NA</code> raster grid cells (Figure <a href="geometric-operations.html#fig:raster-vectorization1">5.23</a>).
Setting the <code>spatial</code> parameter to <code>TRUE</code> is needed to get a spatial object instead of a matrix.</p>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="geometric-operations.html#cb203-1"></a>elev_point =<span class="st"> </span><span class="kw">rasterToPoints</span>(elev, <span class="dt">spatial =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb203-2"><a href="geometric-operations.html#cb203-2"></a><span class="st">  </span><span class="kw">st_as_sf</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:raster-vectorization1"></span>
<img src="05-geometry-operations_files/figure-html/raster-vectorization1-1.png" alt="Raster and point representation of the elev object." width="100%" />
<p class="caption">
FIGURE 5.23: Raster and point representation of the elev object.
</p>
</div>
<p>Another common type of spatial vectorization is the creation of contour lines representing lines of continuous height or temperatures (isotherms) for example.
We will use a real-world digital elevation model (DEM) because the artificial raster <code>elev</code> produces parallel lines (task: verify this and explain why this happens).
<!-- because when creating it we made the upper left corner the lowest and the lower right corner the highest value while increasing cell values by one from left to right. -->
Contour lines can be created with the <strong>raster</strong> function <code>rasterToContour()</code>, which is itself a wrapper around <code>contourLines()</code>, as demonstrated below (not shown):</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="geometric-operations.html#cb204-1"></a><span class="kw">data</span>(dem, <span class="dt">package =</span> <span class="st">&quot;spDataLarge&quot;</span>)</span>
<span id="cb204-2"><a href="geometric-operations.html#cb204-2"></a>cl =<span class="st"> </span><span class="kw">rasterToContour</span>(dem)</span>
<span id="cb204-3"><a href="geometric-operations.html#cb204-3"></a><span class="kw">plot</span>(dem, <span class="dt">axes =</span> <span class="ot">FALSE</span>)</span>
<span id="cb204-4"><a href="geometric-operations.html#cb204-4"></a><span class="kw">plot</span>(cl, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p>Contours can also be added to existing plots with functions such as <code>contour()</code>, <code>rasterVis::contourplot()</code> or <code>tmap::tm_iso()</code>.
As illustrated in Figure <a href="geometric-operations.html#fig:contour-tmap">5.24</a>, isolines can be labelled.</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="geometric-operations.html#cb205-1"></a><span class="co"># create hillshade</span></span>
<span id="cb205-2"><a href="geometric-operations.html#cb205-2"></a>hs =<span class="st"> </span><span class="kw">hillShade</span>(<span class="dt">slope =</span> <span class="kw">terrain</span>(dem, <span class="st">&quot;slope&quot;</span>), <span class="dt">aspect =</span> <span class="kw">terrain</span>(dem, <span class="st">&quot;aspect&quot;</span>))</span>
<span id="cb205-3"><a href="geometric-operations.html#cb205-3"></a><span class="kw">plot</span>(hs, <span class="dt">col =</span> <span class="kw">gray</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">100</span> <span class="op">/</span><span class="st"> </span><span class="dv">100</span>), <span class="dt">legend =</span> <span class="ot">FALSE</span>)</span>
<span id="cb205-4"><a href="geometric-operations.html#cb205-4"></a><span class="co"># overlay with DEM</span></span>
<span id="cb205-5"><a href="geometric-operations.html#cb205-5"></a><span class="kw">plot</span>(dem, <span class="dt">col =</span> <span class="kw">terrain.colors</span>(<span class="dv">25</span>), <span class="dt">alpha =</span> <span class="fl">0.5</span>, <span class="dt">legend =</span> <span class="ot">FALSE</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb205-6"><a href="geometric-operations.html#cb205-6"></a><span class="co"># add contour lines</span></span>
<span id="cb205-7"><a href="geometric-operations.html#cb205-7"></a><span class="kw">contour</span>(dem, <span class="dt">col =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p></p>
<div class="figure" style="text-align: center"><span id="fig:contour-tmap"></span>
<img src="figures/contour-tmap-1.png" alt="DEM hillshade of the southern flank of Mt. Mongón overlaid by contour lines." width="100%" />
<p class="caption">
FIGURE 5.24: DEM hillshade of the southern flank of Mt. Mongón overlaid by contour lines.
</p>
</div>
<p>The final type of vectorization involves conversion of rasters to polygons.
This can be done with <code>raster::rasterToPolygons()</code>, which converts each raster cell into a polygon consisting of five coordinates, all of which are stored in memory (explaining why rasters are often fast compared with vectors!).</p>
<p>This is illustrated below by converting the <code>grain</code> object into polygons and subsequently dissolving borders between polygons with the same attribute values (also see the <code>dissolve</code> argument in <code>rasterToPolygons()</code>).
Attributes in this case are stored in a column called <code>layer</code> (see Section <a href="geometric-operations.html#geometry-unions">5.2.6</a> and Figure <a href="geometric-operations.html#fig:raster-vectorization2">5.25</a>).
(Note: a convenient alternative for converting rasters into polygons is <code>spex::polygonize()</code> which by default returns an <code>sf</code> object.)</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="geometric-operations.html#cb206-1"></a>grain_poly =<span class="st"> </span><span class="kw">rasterToPolygons</span>(grain) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb206-2"><a href="geometric-operations.html#cb206-2"></a><span class="st">  </span><span class="kw">st_as_sf</span>()</span>
<span id="cb206-3"><a href="geometric-operations.html#cb206-3"></a>grain_poly2 =<span class="st"> </span>grain_poly <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb206-4"><a href="geometric-operations.html#cb206-4"></a><span class="st">  </span><span class="kw">group_by</span>(layer) <span class="op">%&gt;%</span></span>
<span id="cb206-5"><a href="geometric-operations.html#cb206-5"></a><span class="st">  </span><span class="kw">summarize</span>()</span>
<span id="cb206-6"><a href="geometric-operations.html#cb206-6"></a><span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span></span>
<span id="cb206-7"><a href="geometric-operations.html#cb206-7"></a><span class="co">#&gt; although coordinates are longitude/latitude, st_union assumes that they are planar</span></span>
<span id="cb206-8"><a href="geometric-operations.html#cb206-8"></a><span class="co">#&gt; although coordinates are longitude/latitude, st_union assumes that they are planar</span></span>
<span id="cb206-9"><a href="geometric-operations.html#cb206-9"></a><span class="co">#&gt; although coordinates are longitude/latitude, st_union assumes that they are planar</span></span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:raster-vectorization2"></span>
<img src="05-geometry-operations_files/figure-html/raster-vectorization2-1.png" alt="Illustration of vectorization of raster (left) into polygon (center) and polygon aggregation (right)." width="100%" />
<p class="caption">
FIGURE 5.25: Illustration of vectorization of raster (left) into polygon (center) and polygon aggregation (right).
</p>
</div>
<!-- ## distances? -->
</div>
</div>
<div id="exercises-3" class="section level2">
<h2><span class="header-section-number">5.5</span> Exercises</h2>
<p>Some of the exercises use a vector (<code>random_points</code>) and raster dataset (<code>ndvi</code>) from the <strong>RQGIS</strong> package.
They also use a polygonal ‘convex hull’ derived from the vector dataset (<code>ch</code>) to represent the area of interest:</p>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="geometric-operations.html#cb207-1"></a><span class="kw">library</span>(RQGIS)</span>
<span id="cb207-2"><a href="geometric-operations.html#cb207-2"></a><span class="kw">data</span>(random_points)</span>
<span id="cb207-3"><a href="geometric-operations.html#cb207-3"></a><span class="kw">data</span>(ndvi)</span>
<span id="cb207-4"><a href="geometric-operations.html#cb207-4"></a>ch =<span class="st"> </span><span class="kw">st_combine</span>(random_points) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb207-5"><a href="geometric-operations.html#cb207-5"></a><span class="st">  </span><span class="kw">st_convex_hull</span>()</span></code></pre></div>
<ol style="list-style-type: decimal">
<li><p>Generate and plot simplified versions of the <code>nz</code> dataset.
Experiment with different values of <code>keep</code> (ranging from 0.5 to 0.00005) for <code>ms_simplify()</code> and <code>dTolerance</code> (from 100 to 100,000) <code>st_simplify()</code> .</p>
<ul>
<li>At what value does the form of the result start to break down for each method, making New Zealand unrecognizable?</li>
<li>Advanced: What is different about the geometry type of the results from <code>st_simplify()</code> compared with the geometry type of <code>ms_simplify()</code>? What problems does this create and how can this be resolved?</li>
</ul></li>
<li><p>In the first exercise in Chapter <a href="spatial-operations.html#spatial-operations">4</a> it was established that Canterbury region had 70 of the 101 highest points in New Zealand.
Using <code>st_buffer()</code>, how many points in <code>nz_height</code> are within 100 km of Canterbury?</p></li>
<li><p>Find the geographic centroid of New Zealand.
How far is it from the geographic centroid of Canterbury?</p></li>
<li><p>Most world maps have a north-up orientation.
A world map with a south-up orientation could be created by a reflection (one of the affine transformations not mentioned in Section <a href="geometric-operations.html#affine-transformations">5.2.4</a>) of the <code>world</code> object’s geometry.
Write code to do so.
Hint: you need to use a two-element vector for this transformation.</p>
<ul>
<li>Bonus: create an upside-down map of your country.</li>
</ul></li>
<li><p>Subset the point in <code>p</code> that is contained within <code>x</code> <em>and</em> <code>y</code> (see Section <a href="geometric-operations.html#clipping">5.2.5</a> and Figure <a href="geometric-operations.html#fig:venn-clip">5.8</a>).</p>
<ul>
<li>Using base subsetting operators.</li>
<li>Using an intermediary object created with <code>st_intersection()</code>.</li>
</ul></li>
<li><p>Calculate the length of the boundary lines of US states in meters.
Which state has the longest border and which has the shortest?
Hint: The <code>st_length</code> function computes the length of a <code>LINESTRING</code> or <code>MULTILINESTRING</code> geometry.</p></li>
<li><p>Crop the <code>ndvi</code> raster using (1) the <code>random_points</code> dataset and (2) the <code>ch</code> dataset.
Are there any differences in the output maps?
Next, mask <code>ndvi</code> using these two datasets.
Can you see any difference now?
How can you explain that?</p></li>
<li><p>Firstly, extract values from <code>ndvi</code> at the points represented in <code>random_points</code>.
Next, extract average values of <code>ndvi</code> using a 90 buffer around each point from <code>random_points</code> and compare these two sets of values.
When would extracting values by buffers be more suitable than by points alone?</p></li>
<li><p>Subset points higher than 3100 meters in New Zealand (the <code>nz_height</code> object) and create a template raster with a resolution of 3 km.
Using these objects:</p>
<ul>
<li>Count numbers of the highest points in each grid cell.</li>
<li>Find the maximum elevation in each grid cell.</li>
</ul></li>
<li><p>Aggregate the raster counting high points in New Zealand (created in the previous exercise), reduce its geographic resolution by half (so cells are 6 by 6 km) and plot the result.</p>
<ul>
<li>Resample the lower resolution raster back to a resolution of 3 km. How have the results changed?</li>
<li>Name two advantages and disadvantages of reducing raster resolution.</li>
</ul></li>
<li><p>Polygonize the <code>grain</code> dataset and filter all squares representing clay.</p>
<ul>
<li>Name two advantages and disadvantages of vector data over raster data.</li>
<li>At which points would it be useful to convert rasters to vectors in your work?</li>
</ul></li>
</ol>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-douglas_algorithms_1973">
<p>Douglas, David H, and Thomas K Peucker. 1973. “Algorithms for the Reduction of the Number of Points Required to Represent a Digitized Line or Its Caricature.” <em>Cartographica: The International Journal for Geographic Information and Geovisualization</em> 10 (2): 112–22.</p>
</div>
<div id="ref-grolemund_r_2016">
<p>Grolemund, Garrett, and Hadley Wickham. 2016. <em>R for Data Science</em>. O’Reilly Media.</p>
</div>
<div id="ref-hunziker_velox:_2017">
<p>Hunziker, Philipp. 2017. <em>Velox: Fast Raster Manipulation and Extraction</em>.</p>
</div>
<div id="ref-liu_essential_2009">
<p>Liu, Jian-Guo, and Philippa J. Mason. 2009. <em>Essential Image Processing and GIS for Remote Sensing</em>. Chichester, West Sussex, UK, Hoboken, NJ: Wiley-Blackwell.</p>
</div>
<div id="ref-visvalingam_line_1993">
<p>Visvalingam, M., and J. D. Whyatt. 1993. “Line Generalisation by Repeated Elimination of Points.” <em>The Cartographic Journal</em> 30 (1): 46–51. <a href="https://doi.org/10.1179/000870493786962263">https://doi.org/10.1179/000870493786962263</a>.</p>
</div>
<div id="ref-wickham_advanced_2014">
<p>Wickham, Hadley. 2014a. <em>Advanced R</em>. CRC Press.</p>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="19">
<li id="fn19"><p>
Simplification of multipolygon objects can remove small internal polygons, even if the <code>keep_shapes</code> argument is set to TRUE. To prevent this, you need to set <code>explode = TRUE</code>. This option converts all mutlipolygons into separate polygons before its simplification.<a href="geometric-operations.html#fnref19" class="footnote-back">↩︎</a></p></li>
<li id="fn20"><p>
A description of how <code>st_point_on_surface()</code> works is provided at <a href="https://gis.stackexchange.com/q/76498" class="uri">https://gis.stackexchange.com/q/76498</a>.<a href="geometric-operations.html#fnref20" class="footnote-back">↩︎</a></p></li>
<li id="fn21"><p>
If the origins of two raster datasets are just marginally apart, it sometimes is sufficient to simply increase the <code>tolerance</code> argument of <code>raster::rasterOptions()</code>.<a href="geometric-operations.html#fnref21" class="footnote-back">↩︎</a></p></li>
<li id="fn22"><p>
Here we refer to spatial resolution.
In remote sensing the spectral (spectral bands), temporal (observations through time of the same area) and radiometric (color depth) resolution are also important.
Check out the <code>stackApply()</code> example in the documentation for getting an idea on how to do temporal raster aggregation.<a href="geometric-operations.html#fnref22" class="footnote-back">↩︎</a></p></li>
<li id="fn23"><p>
See more at <a href="http://gdal.org/gdal_rasterize.html" class="uri">http://gdal.org/gdal_rasterize.html</a>.<a href="geometric-operations.html#fnref23" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
<script>
/*
Sorts the references alphabetically.
Modified from code by Yvonne Aburrow.
*/
$(function(){
    var elems = $('#refs').children('div').remove();
    elems.sort(function (a, b) {
        return $(b).children('p').html().toUpperCase() > $(a).children('p').html().toUpperCase() ? -1 : 1;
    });
    $('#refs').append(elems);
})
</script>
            </section>

          </div>
        </div>
      </div>
<a href="spatial-operations.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="reproj-geo-data.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": null,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/Robinlovelace/geocompr/edit/master/05-geometry-operations.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
